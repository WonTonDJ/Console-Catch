<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Console Catch ğŸ®</title>
<script src="/socket.io/socket.io.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Orbitron:wght@400;700;900&family=Rajdhani:wght@400;600;700&display=swap');

/* â”€â”€â”€ TOKENS â”€â”€â”€ */
:root{
  --bg:#0a0a0f; --s1:#13131e; --s2:#1c1c2a; --s3:#242436;
  --text:#e8e8ff; --muted:rgba(200,200,255,.42);
  --gold:#ffd700; --lucky:#00ffff;
  --green:#00e676; --red:#ff1744; --yellow:#ffea00;
  --blue:#448aff; --orange:#ff6d00;
  --r:12px;
}
*{margin:0;padding:0;box-sizing:border-box;}
html,body{height:100%;}
body{
  font-family:'Rajdhani',sans-serif;
  background:var(--bg);color:var(--text);
  min-height:100vh;overflow-x:hidden;
  user-select:none;-webkit-tap-highlight-color:transparent;
}
/* scanlines */
body::before{
  content:'';position:fixed;inset:0;pointer-events:none;z-index:9999;
  background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,0,0,.055) 2px,rgba(0,0,0,.055) 4px);
}

/* â”€â”€â”€ SCREENS â”€â”€â”€ */
.screen{display:none;min-height:100vh;flex-direction:column;align-items:center;}
.screen.active{display:flex;}

/* â”€â”€â”€ CONNECTION PILL â”€â”€â”€ */
#connPill{
  position:fixed;top:10px;right:12px;z-index:600;
  font-family:'Orbitron',sans-serif;font-size:9px;letter-spacing:1px;
  padding:4px 10px;border-radius:20px;transition:all .3s;pointer-events:none;
}
#connPill.ok{background:rgba(0,230,118,.12);color:var(--green);border:1px solid rgba(0,230,118,.3);}
#connPill.bad{background:rgba(255,23,68,.12);color:var(--red);border:1px solid rgba(255,23,68,.3);}
#connPill.wait{background:rgba(255,234,0,.12);color:var(--yellow);border:1px solid rgba(255,234,0,.3);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MAIN MENU
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#lobby{
  background:
    radial-gradient(ellipse at 28% 18%,#1a0533,transparent 58%),
    radial-gradient(ellipse at 80% 82%,#001a3a,transparent 48%),
    var(--bg);
  padding:24px 20px;justify-content:center;
}
.logo{text-align:center;margin-bottom:26px;}
.logo h1{
  font-family:'Press Start 2P',monospace;
  font-size:clamp(15px,5vw,28px);color:var(--gold);line-height:1.6;
  text-shadow:0 0 20px rgba(255,215,0,.6),4px 4px 0 #8B6914;
  animation:glow 2s ease-in-out infinite alternate;
}
.logo sub{font-family:'Orbitron',sans-serif;font-size:10px;color:var(--muted);letter-spacing:3px;display:block;margin-top:8px;}
@keyframes glow{
  from{text-shadow:0 0 20px rgba(255,215,0,.6),4px 4px 0 #8B6914;}
  to  {text-shadow:0 0 50px rgba(255,215,0,1),0 0 90px rgba(255,165,0,.35),4px 4px 0 #8B6914;}
}

.parade{display:flex;gap:7px;justify-content:center;margin-bottom:22px;flex-wrap:wrap;max-width:320px;}
.pc{width:36px;height:50px;border-radius:6px;border:2px solid rgba(255,255,255,.14);
    display:flex;align-items:center;justify-content:center;font-size:17px;
    animation:float 3s ease-in-out infinite;}
.pc:nth-child(2){animation-delay:.3s}.pc:nth-child(3){animation-delay:.6s}
.pc:nth-child(4){animation-delay:.9s}.pc:nth-child(5){animation-delay:1.2s}
.pc:nth-child(6){animation-delay:1.5s}.pc:nth-child(7){animation-delay:1.8s}
@keyframes float{0%,100%{transform:translateY(0) rotate(-3deg);}50%{transform:translateY(-8px) rotate(3deg);}}

.menu-box{
  background:var(--s1);border:1px solid rgba(255,255,255,.08);
  border-radius:var(--r);padding:22px;width:100%;max-width:380px;
  box-shadow:0 0 60px rgba(0,0,0,.5);
}
.field{margin-bottom:14px;}
.field label{display:block;font-family:'Orbitron',sans-serif;font-size:9px;letter-spacing:2px;color:var(--muted);margin-bottom:7px;}
.field input{
  width:100%;background:var(--s2);border:1px solid rgba(255,255,255,.11);
  border-radius:8px;padding:11px 14px;color:var(--text);
  font-family:'Rajdhani',sans-serif;font-size:16px;font-weight:700;outline:none;
  transition:border-color .2s,box-shadow .2s;
}
.field input:focus{border-color:var(--gold);box-shadow:0 0 14px rgba(255,215,0,.14);}
.divider{text-align:center;color:rgba(255,255,255,.18);font-size:10px;letter-spacing:3px;margin:14px 0;font-family:'Orbitron',sans-serif;}

/* â”€â”€â”€ BUTTONS â”€â”€â”€ */
.btn{
  width:100%;padding:13px;border:none;border-radius:10px;
  font-family:'Press Start 2P',monospace;font-size:10px;cursor:pointer;
  transition:all .15s;letter-spacing:1px;position:relative;overflow:hidden;
}
.btn::after{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;
  background:linear-gradient(90deg,transparent,rgba(255,255,255,.12),transparent);transition:left .35s;}
.btn:hover:not(:disabled)::after{left:100%;}
.btn:active:not(:disabled){transform:scale(.97);}
.btn:disabled{opacity:.35;cursor:not-allowed;}
.btn-gold{background:linear-gradient(135deg,#ffd700,#ff8c00);color:#000;
  box-shadow:0 4px 18px rgba(255,150,0,.35);margin-bottom:10px;}
.btn-gold:hover:not(:disabled){box-shadow:0 6px 28px rgba(255,180,0,.55);}
.btn-dim{background:var(--s2);color:var(--text);border:1px solid rgba(255,255,255,.13);}

/* â”€â”€â”€ SMALL BUTTONS â”€â”€â”€ */
.sbtn{
  padding:7px 13px;border:none;border-radius:8px;
  font-family:'Orbitron',sans-serif;font-size:9px;letter-spacing:1px;
  cursor:pointer;transition:all .15s;white-space:nowrap;
}
.sbtn:active{transform:scale(.95);}
.sbtn:disabled{opacity:.3;cursor:not-allowed;}
.sbtn-green{background:rgba(0,230,118,.14);color:var(--green);border:1px solid rgba(0,230,118,.3);}
.sbtn-green:hover:not(:disabled){background:rgba(0,230,118,.24);}
.sbtn-red{background:rgba(255,23,68,.11);color:#ff6b6b;border:1px solid rgba(255,23,68,.28);}
.sbtn-red:hover:not(:disabled){background:rgba(255,23,68,.2);}
.sbtn-blue{background:rgba(68,138,255,.14);color:var(--blue);border:1px solid rgba(68,138,255,.3);}
.sbtn-blue:hover:not(:disabled){background:rgba(68,138,255,.24);}
.sbtn-gold{background:rgba(255,215,0,.14);color:var(--gold);border:1px solid rgba(255,215,0,.3);}
.sbtn-gold:hover:not(:disabled){background:rgba(255,215,0,.24);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   WAITING ROOM (real-time lobby)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#waiting{
  background:
    radial-gradient(ellipse at 50% 0%,#0d1540,transparent 55%),
    var(--bg);
  padding:0;justify-content:flex-start;gap:0;
}

/* top bar */
.wait-topbar{
  width:100%;background:var(--s1);border-bottom:1px solid rgba(255,255,255,.07);
  padding:10px 16px;display:flex;align-items:center;gap:12px;
}
.back-btn{
  background:var(--s2);border:1px solid rgba(255,255,255,.12);border-radius:8px;
  padding:7px 12px;font-family:'Orbitron',sans-serif;font-size:9px;letter-spacing:1px;
  color:var(--muted);cursor:pointer;transition:all .15s;flex-shrink:0;
}
.back-btn:hover{color:var(--text);border-color:rgba(255,255,255,.28);}
.wait-title{flex:1;font-family:'Press Start 2P',monospace;font-size:11px;color:var(--gold);text-align:center;}

/* room code hero */
.code-hero{
  width:100%;max-width:480px;margin:20px auto 0;padding:0 16px;
}
.code-card{
  background:var(--s1);border:1px solid rgba(255,255,255,.08);border-radius:14px;
  padding:18px 20px;text-align:center;
}
.code-label{font-family:'Orbitron',sans-serif;font-size:9px;letter-spacing:3px;color:var(--muted);margin-bottom:10px;}
.code-value{
  font-family:'Press Start 2P',monospace;font-size:clamp(22px,6vw,32px);
  color:var(--lucky);letter-spacing:8px;
  text-shadow:0 0 20px rgba(0,255,255,.4);margin-bottom:14px;
}
.code-actions{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;}

/* share link */
.share-link{
  width:100%;max-width:480px;padding:0 16px;margin-top:10px;
}
.share-link-inner{
  background:var(--s2);border:1px solid rgba(255,255,255,.08);border-radius:10px;
  padding:10px 14px;display:flex;align-items:center;gap:10px;
}
.share-link-inner span{
  flex:1;font-family:'Orbitron',sans-serif;font-size:9px;letter-spacing:1px;
  color:var(--muted);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;
}

/* player list */
.lobby-panel{
  width:100%;max-width:480px;padding:0 16px;margin-top:14px;flex:1;
}
.lobby-panel-hdr{
  display:flex;align-items:center;justify-content:space-between;
  font-family:'Orbitron',sans-serif;font-size:9px;letter-spacing:2px;color:var(--muted);
  margin-bottom:8px;padding:0 2px;
}
.slots-grid{display:flex;flex-direction:column;gap:6px;}

/* individual slot */
.slot{
  background:var(--s1);border:1px solid rgba(255,255,255,.07);
  border-radius:10px;padding:10px 14px;
  display:flex;align-items:center;gap:12px;
  transition:all .3s;min-height:56px;
}
.slot.human{border-color:rgba(0,230,118,.25);background:rgba(0,230,118,.03);}
.slot.you  {border-color:rgba(255,215,0,.35);background:rgba(255,215,0,.04);}
.slot.bot  {border-color:rgba(68,138,255,.22);background:rgba(68,138,255,.03);}
.slot.empty{border-style:dashed;border-color:rgba(255,255,255,.1);background:transparent;}
.slot-av  {font-size:24px;flex-shrink:0;}
.slot-info{flex:1;}
.slot-name{font-size:15px;font-weight:700;}
.slot-sub {font-family:'Orbitron',sans-serif;font-size:8px;letter-spacing:1px;margin-top:2px;}
.slot-sub.host-tag{color:var(--gold);}
.slot-sub.bot-tag {color:var(--blue);}
.slot-sub.you-tag {color:var(--green);}
.slot-sub.empty-tag{color:rgba(255,255,255,.18);}
.slot-badge{
  font-family:'Press Start 2P',monospace;font-size:7px;
  padding:3px 7px;border-radius:6px;flex-shrink:0;
}
.badge-host{background:rgba(255,215,0,.15);color:var(--gold);border:1px solid rgba(255,215,0,.3);}
.badge-bot {background:rgba(68,138,255,.15);color:var(--blue);border:1px solid rgba(68,138,255,.3);}
.badge-you {background:rgba(0,230,118,.12);color:var(--green);border:1px solid rgba(0,230,118,.25);}
.badge-rdy {background:rgba(0,230,118,.08);color:rgba(0,230,118,.7);border:1px solid rgba(0,230,118,.15);}

/* join pulse for new players */
@keyframes slotPop{
  0%{transform:scale(.9);opacity:0;}
  60%{transform:scale(1.03);}
  100%{transform:scale(1);opacity:1;}
}
.slot.popped{animation:slotPop .35s ease-out;}

/* bot control row */
.bot-row{
  width:100%;max-width:480px;padding:0 16px;margin-top:10px;
  display:none;gap:8px;
}
.bot-row.visible{display:flex;}
.bot-row-label{
  font-family:'Orbitron',sans-serif;font-size:9px;letter-spacing:1px;
  color:var(--muted);align-self:center;flex-shrink:0;
}

/* bot count display */
.bot-count-row{
  width:100%;max-width:480px;padding:0 16px;margin-top:6px;
  display:flex;gap:6px;flex-wrap:wrap;
}
.preset-btn{
  flex:1;min-width:52px;padding:6px 4px;border:none;border-radius:8px;
  font-family:'Press Start 2P',monospace;font-size:7px;cursor:pointer;
  background:var(--s2);color:var(--muted);border:1px solid rgba(255,255,255,.1);
  transition:all .15s;text-align:center;
}
.preset-btn:hover{border-color:rgba(255,215,0,.35);color:var(--gold);}
.preset-btn.active{background:rgba(255,215,0,.12);border-color:rgba(255,215,0,.5);color:var(--gold);}

/* bottom actions */
.wait-actions{
  width:100%;max-width:480px;padding:14px 16px 24px;margin-top:auto;
}
.waiting-hint{
  text-align:center;font-family:'Orbitron',sans-serif;font-size:9px;
  color:rgba(255,255,255,.22);letter-spacing:1px;padding:10px;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GAME SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#game{
  background:radial-gradient(ellipse at 50% 0%,#0d1a2e,var(--bg) 60%);
  flex-direction:column;min-height:100vh;
}

/* header */
.ghdr{
  background:var(--s1);border-bottom:1px solid rgba(255,255,255,.07);
  padding:8px 14px;display:flex;align-items:center;justify-content:space-between;
  position:sticky;top:0;z-index:100;
}
.chip{
  display:flex;align-items:center;gap:4px;background:var(--s2);
  border-radius:20px;padding:4px 10px;font-family:'Orbitron',sans-serif;
  font-size:11px;font-weight:700;
}
.chip-gold  {color:var(--gold);border:1px solid rgba(255,215,0,.2);}
.chip-lucky {color:var(--lucky);border:1px solid rgba(0,255,255,.2);}
.chip-rnd   {color:rgba(255,255,255,.45);border:1px solid rgba(255,255,255,.08);}
.turn-badge{font-family:'Press Start 2P',monospace;font-size:7px;text-align:center;line-height:1.8;max-width:130px;}

/* big timer */
.timer-wrap{display:flex;align-items:center;background:var(--s2);border-bottom:1px solid rgba(255,255,255,.05);}
.timer-bar{flex:1;height:6px;background:rgba(255,255,255,.06);}
.timer-fill{height:100%;width:100%;transition:width 1s linear,background .5s;}
.timer-num{
  font-family:'Press Start 2P',monospace;font-size:11px;
  min-width:46px;text-align:center;padding:5px 8px;transition:color .3s;
}

/* main content */
.gmain{flex:1;padding:10px;display:flex;flex-direction:column;gap:10px;max-width:620px;width:100%;margin:0 auto;}

/* opponent cards */
.opp-row{display:flex;gap:7px;overflow-x:auto;padding-bottom:2px;}
.ocard{
  background:var(--s1);border:1px solid rgba(255,255,255,.07);
  border-radius:10px;padding:7px 10px;flex-shrink:0;min-width:84px;
  text-align:center;position:relative;cursor:pointer;transition:all .2s;
}
.ocard:hover{border-color:rgba(255,255,255,.25);}
.ocard.cur{border-color:var(--green);box-shadow:0 0 14px rgba(0,230,118,.25);}
.oav{font-size:20px;}.oname{font-size:10px;font-weight:700;margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:76px;}
.oinfo{font-size:8px;color:var(--muted);font-family:'Orbitron',sans-serif;margin-top:2px;}
.osets{font-size:9px;color:var(--green);margin-top:1px;}
.peek{
  display:none;position:absolute;top:calc(100% + 6px);left:50%;transform:translateX(-50%);
  background:#1e1e2e;border:1px solid rgba(255,255,255,.14);border-radius:10px;
  padding:10px;z-index:60;min-width:155px;box-shadow:0 10px 30px rgba(0,0,0,.6);
}
.ocard:hover .peek{display:block;}
.peek-ttl{font-family:'Orbitron',sans-serif;font-size:8px;letter-spacing:2px;color:var(--muted);margin-bottom:6px;}
.peek-cards{display:flex;flex-wrap:wrap;gap:3px;}

/* table */
.table{
  background:var(--s1);border:1px solid rgba(255,255,255,.07);
  border-radius:14px;padding:14px;display:flex;gap:14px;align-items:center;justify-content:center;
}
.pile{text-align:center;flex:1;}
.pile-lbl{font-family:'Orbitron',sans-serif;font-size:8px;letter-spacing:2px;color:var(--muted);margin-bottom:7px;}
.deck-cnt{font-family:'Press Start 2P',monospace;font-size:7px;color:rgba(255,255,255,.22);margin-top:5px;}
.table-sep{font-size:22px;opacity:.18;}

/* â”€â”€â”€ CARDS â”€â”€â”€ */
.card{
  width:68px;height:96px;border-radius:9px;
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  cursor:pointer;transition:transform .18s,box-shadow .18s;
  position:relative;border:2px solid rgba(255,255,255,.12);flex-shrink:0;
}
.card:active{transform:scale(.95)!important;}
.card.hov:hover{transform:translateY(-5px) scale(1.04);}
.card.sel{transform:translateY(-10px) scale(1.07)!important;border-color:var(--gold)!important;box-shadow:0 10px 28px rgba(255,215,0,.5)!important;}
.card.staged{transform:translateY(-5px);border-color:rgba(0,230,118,.7)!important;box-shadow:0 6px 18px rgba(0,230,118,.35)!important;}
.card.locked-c{cursor:default;opacity:.85;}
.card.off{opacity:.4;cursor:not-allowed;}
.card.pulse{animation:cpulse 1.5s infinite;}
@keyframes cpulse{0%,100%{box-shadow:0 0 0 0 rgba(0,230,118,.5);}50%{box-shadow:0 0 0 10px rgba(0,230,118,0);}}
.card-back{background:linear-gradient(135deg,#1a1a2e,#16213e);border:2px solid rgba(100,100,200,.22);}
.card-back::before{
  content:'';position:absolute;inset:4px;border:1px solid rgba(255,255,255,.04);border-radius:5px;
  background:repeating-linear-gradient(45deg,transparent,transparent 4px,rgba(255,255,255,.025) 4px,rgba(255,255,255,.025) 8px);
}
.cem{font-size:24px;margin-bottom:3px;position:relative;z-index:1;}
.cnm{font-size:7px;font-weight:700;text-align:center;padding:0 3px;position:relative;z-index:1;line-height:1.2;font-family:'Rajdhani',sans-serif;}
.card-beige{background:linear-gradient(145deg,#f5deb3,#e0c07a);} .card-beige .cnm{color:rgba(0,0,0,.7);}
.card-green{background:linear-gradient(145deg,#00e676,#009945);} .card-green .cnm{color:rgba(255,255,255,.9);}
.card-blue {background:linear-gradient(145deg,#5c9fff,#1a5fcc);} .card-blue  .cnm{color:rgba(255,255,255,.9);}
.card-yellow{background:linear-gradient(145deg,#ffea00,#d4b800);}  .card-yellow .cnm{color:rgba(0,0,0,.75);}
.card-orange{background:linear-gradient(145deg,#ff6d00,#c43c00);}  .card-orange .cnm{color:rgba(255,255,255,.9);}
.card-grey {background:linear-gradient(145deg,#a0a0a0,#606060);}  .card-grey  .cnm{color:rgba(255,255,255,.9);}
.card-red  {background:linear-gradient(145deg,#ff3355,#aa0022);}  .card-red   .cnm{color:rgba(255,255,255,.9);}
.mpcard{width:26px;height:36px;border-radius:3px;display:flex;align-items:center;justify-content:center;font-size:13px;border:1px solid rgba(255,255,255,.14);}

/* â”€â”€â”€ section boxes â”€â”€â”€ */
.sec{background:var(--s1);border:1px solid rgba(255,255,255,.07);border-radius:14px;padding:11px;}
.sec-hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;}
.sec-ttl{font-family:'Orbitron',sans-serif;font-size:10px;letter-spacing:2px;color:var(--muted);}
.sec-acts{display:flex;gap:6px;align-items:center;}
.hand-cards{display:flex;gap:5px;overflow-x:auto;padding-bottom:3px;flex-wrap:wrap;justify-content:center;}
.hint{font-family:'Orbitron',sans-serif;font-size:8px;color:rgba(255,255,255,.2);text-align:center;margin-top:7px;letter-spacing:1px;line-height:1.5;}

/* locked sets */
.sets-row{display:flex;gap:8px;}
.set-slot{
  flex:1;border:2px dashed rgba(255,255,255,.1);border-radius:10px;
  padding:7px;min-height:82px;display:flex;gap:3px;align-items:center;
  justify-content:center;position:relative;transition:all .25s;flex-wrap:wrap;
}
.set-slot.vp{border-color:var(--green);background:rgba(0,230,118,.05);}
.set-slot.lk{border-color:var(--gold);background:rgba(255,215,0,.06);box-shadow:0 0 14px rgba(255,215,0,.18);}
.slbl{
  position:absolute;top:-9px;left:9px;
  font-family:'Orbitron',sans-serif;font-size:7px;letter-spacing:1px;
  color:rgba(255,255,255,.22);background:var(--s1);padding:0 4px;
}
.set-slot.lk .slbl{color:var(--gold);}
.set-slot.vp .slbl{color:var(--green);}
.plus-hint{font-size:18px;opacity:.12;}

/* lock button */
.lock-btn{
  position:absolute;bottom:-15px;left:50%;transform:translateX(-50%);
  background:linear-gradient(135deg,#ffd700,#ff8c00);border:none;border-radius:6px;
  padding:4px 10px;font-family:'Press Start 2P',monospace;font-size:7px;
  cursor:pointer;color:#000;white-space:nowrap;z-index:10;
  animation:lkpulse 1s infinite;
}
@keyframes lkpulse{0%,100%{box-shadow:0 0 0 0 rgba(255,215,0,.5);}50%{box-shadow:0 0 0 6px rgba(255,215,0,0);}}

/* stage */
.stage-sec{background:var(--s2);border:2px dashed rgba(0,230,118,.18);border-radius:10px;padding:10px;}
.stage-cards{display:flex;gap:5px;flex-wrap:wrap;min-height:40px;align-items:center;}
.stage-empty{font-family:'Orbitron',sans-serif;font-size:8px;letter-spacing:1px;color:rgba(0,230,118,.3);}
.stage-status{font-family:'Orbitron',sans-serif;font-size:9px;margin-top:7px;letter-spacing:1px;text-align:center;min-height:14px;}

/* â”€â”€â”€ Notifications â”€â”€â”€ */
.notif{
  position:fixed;top:58px;left:50%;transform:translateX(-50%);
  background:rgba(12,12,22,.97);border:1px solid rgba(255,255,255,.13);
  border-radius:12px;padding:10px 18px;
  font-family:'Press Start 2P',monospace;font-size:9px;
  z-index:300;max-width:300px;text-align:center;line-height:1.7;
  animation:npop .22s ease-out;pointer-events:none;
}
@keyframes npop{from{transform:translateX(-50%) scale(.75);opacity:0;}to{transform:translateX(-50%) scale(1);opacity:1;}}

.banner{
  position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);
  background:rgba(5,5,12,.97);border:2px solid var(--gold);border-radius:14px;
  padding:18px 36px;font-family:'Press Start 2P',monospace;font-size:15px;
  color:var(--gold);z-index:400;text-align:center;line-height:1.7;
  animation:bpop .35s ease-out;
}
@keyframes bpop{from{transform:translate(-50%,-50%) scale(.5);opacity:0;}to{transform:translate(-50%,-50%) scale(1);opacity:1;}}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   WIN SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#winscreen{
  background:radial-gradient(ellipse at 50% 30%,#1a0d33,var(--bg));
  padding:30px 20px;justify-content:center;text-align:center;gap:0;
}
.trophy{font-size:72px;animation:tspin 2s ease-in-out infinite;}
@keyframes tspin{0%,100%{transform:rotate(-5deg) scale(1);}50%{transform:rotate(5deg) scale(1.1);}}
.wt{font-family:'Press Start 2P',monospace;font-size:clamp(13px,4vw,20px);color:var(--gold);margin:18px 0 8px;line-height:1.5;text-shadow:0 0 30px rgba(255,215,0,.5);}
.ws{font-size:20px;font-weight:700;color:var(--lucky);margin-bottom:18px;}
.rewards{display:flex;gap:14px;justify-content:center;margin:14px 0;}
.rwrd{background:var(--s1);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:14px 18px;text-align:center;}
.rwrd .re{font-size:28px;display:block;margin-bottom:5px;}
.rwrd .ra{font-family:'Press Start 2P',monospace;font-size:14px;color:var(--gold);}
.rwrd .rl{font-family:'Orbitron',sans-serif;font-size:8px;color:var(--muted);letter-spacing:2px;margin-top:3px;}
.lb{width:100%;max-width:340px;margin:14px 0;}
.lb-h{font-family:'Press Start 2P',monospace;font-size:9px;color:var(--muted);margin-bottom:10px;}
.lbr{display:flex;align-items:center;gap:10px;background:var(--s1);border-radius:8px;padding:9px 12px;margin-bottom:5px;border:1px solid rgba(255,255,255,.06);}
.lbr.win{border-color:rgba(255,215,0,.4);background:rgba(255,215,0,.05);}
.lpos{font-family:'Press Start 2P',monospace;font-size:10px;width:20px;color:var(--muted);}
.lav{font-size:20px;}.lnm{flex:1;font-size:14px;font-weight:700;}.lsc{font-family:'Orbitron',sans-serif;font-size:10px;color:var(--gold);}
.shop-modal{display:none;width:100%;max-width:340px;background:var(--s1);border-radius:14px;padding:18px;border:1px solid rgba(255,255,255,.08);margin-bottom:16px;}
.shop-ttl{font-family:'Press Start 2P',monospace;font-size:10px;color:var(--gold);margin-bottom:14px;}
.si{display:flex;align-items:center;gap:10px;padding:9px;border-bottom:1px solid rgba(255,255,255,.04);}
.si:last-child{border-bottom:none;}
.si-e{font-size:26px;}.si-i{flex:1;}.si-n{font-size:13px;font-weight:700;}.si-r{font-size:9px;color:var(--muted);font-family:'Orbitron',sans-serif;}
.si-b{background:linear-gradient(135deg,#ffd700,#ff8c00);border:none;border-radius:7px;padding:5px 8px;font-family:'Press Start 2P',monospace;font-size:7px;cursor:pointer;color:#000;}

/* confetti */
.cfp{position:fixed;width:8px;height:8px;border-radius:2px;animation:cfall linear forwards;z-index:500;pointer-events:none;}
@keyframes cfall{0%{transform:translateY(-10vh) rotate(0);opacity:1;}100%{transform:translateY(110vh) rotate(720deg);opacity:0;}}

@media(max-width:380px){.card{width:56px;height:80px;}.cem{font-size:19px;}.cnm{font-size:6px;}}
</style>
</head>
<body>

<div id="connPill" class="wait">â— CONNECTING</div>

<!-- â•â•â•â•â•â•â•â• MAIN MENU â•â•â•â•â•â•â•â• -->
<div id="lobby" class="screen active">
  <div class="logo">
    <h1>ğŸ® CONSOLE<br>CATCH</h1>
    <sub>REAL-TIME MULTIPLAYER</sub>
  </div>
  <div class="parade">
    <div class="pc card-beige">ğŸ•¹ï¸</div><div class="pc card-green">ğŸ“€</div>
    <div class="pc card-blue">ğŸ’¿</div><div class="pc card-yellow">ğŸŸ©</div>
    <div class="pc card-orange">ğŸ²</div><div class="pc card-grey">âŒ¨ï¸</div>
    <div class="pc card-red">ğŸ¥½</div>
  </div>
  <div class="menu-box">
    <div class="field">
      <label>YOUR NAME</label>
      <input id="nameIn" placeholder="Enter your nameâ€¦" maxlength="16" autocomplete="off">
    </div>
    <button class="btn btn-gold" onclick="hostGame()">ğŸ  HOST A GAME</button>
    <div class="divider">â€” OR JOIN â€”</div>
    <div class="field">
      <label>ROOM CODE</label>
      <input id="codeIn" placeholder="e.g. SONIC42" maxlength="10"
        style="text-transform:uppercase;letter-spacing:4px;font-family:'Press Start 2P',monospace;font-size:12px;"
        autocomplete="off">
    </div>
    <button class="btn btn-dim" onclick="joinGame()">ğŸ® JOIN GAME</button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â• WAITING ROOM â•â•â•â•â•â•â•â• -->
<div id="waiting" class="screen">

  <div class="wait-topbar">
    <button class="back-btn" onclick="leaveRoom()">â† BACK</button>
    <div class="wait-title">ğŸ® LOBBY</div>
    <div style="width:60px;"></div><!-- spacer -->
  </div>

  <!-- Room code -->
  <div class="code-hero">
    <div class="code-card">
      <div class="code-label">SHARE THIS CODE WITH FRIENDS</div>
      <div class="code-value" id="dispCode">â€”â€”</div>
      <div class="code-actions">
        <button class="sbtn sbtn-blue" onclick="copyCode()">ğŸ“‹ COPY CODE</button>
        <button class="sbtn sbtn-gold" onclick="copyLink()">ğŸ”— COPY LINK</button>
      </div>
    </div>
  </div>

  <!-- Share URL bar -->
  <div class="share-link">
    <div class="share-link-inner">
      <span id="shareUrl">â€”</span>
      <button class="sbtn sbtn-green" onclick="copyLink()" style="flex-shrink:0;">COPY</button>
    </div>
  </div>

  <!-- Live player list -->
  <div class="lobby-panel">
    <div class="lobby-panel-hdr">
      <span>PLAYERS IN LOBBY</span>
      <span id="lobbyCount">0 / 6</span>
    </div>
    <div class="slots-grid" id="slotsGrid">
      <!-- injected by renderLobby() -->
    </div>
  </div>

  <!-- Bot controls (host only) -->
  <div class="bot-row" id="botRow">
    <span class="bot-row-label">ğŸ¤– BOTS:</span>
    <button class="sbtn sbtn-green" onclick="addBot()">+ ADD</button>
    <button class="sbtn sbtn-red"   onclick="removeBot()">âˆ’ REMOVE</button>
  </div>

  <!-- Bot preset buttons (host only) -->
  <div class="bot-count-row" id="presetRow" style="display:none;">
    <button class="preset-btn" onclick="setBots(0)" id="pre0">0 bots</button>
    <button class="preset-btn" onclick="setBots(1)" id="pre1">1 bot</button>
    <button class="preset-btn" onclick="setBots(2)" id="pre2">2 bots</button>
    <button class="preset-btn" onclick="setBots(3)" id="pre3">3 bots</button>
    <button class="preset-btn" onclick="setBots(4)" id="pre4">4 bots</button>
    <button class="preset-btn" onclick="setBots(5)" id="pre5">5 bots</button>
  </div>

  <!-- Start / waiting message -->
  <div class="wait-actions">
    <button class="btn btn-gold" id="startBtn" style="display:none;" onclick="startGame()">â–¶ START GAME</button>
    <div class="waiting-hint" id="waitMsg">Waiting for host to start the gameâ€¦</div>
  </div>

</div>

<!-- â•â•â•â•â•â•â•â• GAME â•â•â•â•â•â•â•â• -->
<div id="game" class="screen">
  <div class="ghdr">
    <div style="display:flex;gap:7px;">
      <div class="chip chip-gold">ğŸ¥‡<span id="goldCnt">0</span></div>
      <div class="chip chip-lucky">ğŸ€<span id="luckyCnt">0</span></div>
    </div>
    <div class="turn-badge" id="turnBadge">â€”</div>
    <div class="chip chip-rnd">R<span id="rndNum">1</span></div>
  </div>

  <div class="timer-wrap">
    <div class="timer-bar"><div class="timer-fill" id="timerFill"></div></div>
    <div class="timer-num" id="timerNum" style="color:var(--green);">30</div>
  </div>

  <div class="gmain">

    <!-- Opponents -->
    <div>
      <div style="font-family:'Orbitron',sans-serif;font-size:8px;letter-spacing:2px;color:rgba(255,255,255,.26);margin-bottom:7px;">OTHER PLAYERS</div>
      <div class="opp-row" id="oppRow"></div>
    </div>

    <!-- Draw table -->
    <div class="table">
      <div class="pile">
        <div class="pile-lbl">DECK</div>
        <div class="card card-back" id="deckCard" onclick="drawDeck()">
          <div class="cem" style="position:relative;z-index:1;">ğŸ®</div>
        </div>
        <div class="deck-cnt" id="deckCnt">â€” cards</div>
      </div>
      <div class="table-sep">âš¡</div>
      <div class="pile">
        <div class="pile-lbl">DISCARD</div>
        <div class="card" id="discardTop" onclick="drawDiscard()">
          <div class="cem">â™»ï¸</div>
          <div class="cnm" style="color:rgba(255,255,255,.3);">Empty</div>
        </div>
      </div>
    </div>

    <!-- Locked sets -->
    <div class="sec">
      <div class="sec-hdr">
        <div class="sec-ttl">ğŸ”’ LOCKED SETS (<span id="lockCnt">0</span>/3)</div>
        <div style="font-family:'Orbitron',sans-serif;font-size:8px;color:var(--muted);">Lock 3 sets to WIN</div>
      </div>
      <div class="sets-row" id="setsRow">
        <div class="set-slot" id="set0"><span class="slbl">SET 1</span><div class="plus-hint">+</div></div>
        <div class="set-slot" id="set1"><span class="slbl">SET 2</span><div class="plus-hint">+</div></div>
        <div class="set-slot" id="set2"><span class="slbl">SET 3</span><div class="plus-hint">+</div></div>
      </div>
    </div>

    <!-- Stage area -->
    <div class="sec">
      <div class="sec-hdr">
        <div class="sec-ttl">ğŸ¯ BUILD A SET</div>
        <div class="sec-acts">
          <button class="sbtn sbtn-red"  id="clearStBtn" onclick="clearStage()" disabled>âœ• Clear</button>
          <button class="sbtn sbtn-gold" id="lockStBtn"  onclick="lockStage()"  disabled>ğŸ”’ LOCK SET</button>
        </div>
      </div>
      <div class="stage-sec">
        <div class="stage-cards" id="stageCards">
          <div class="stage-empty" id="stageEmpty">Tap cards from your hand to add them here (need 3)</div>
        </div>
        <div class="stage-status" id="stageStat"></div>
      </div>
    </div>

    <!-- Hand -->
    <div class="sec">
      <div class="sec-hdr">
        <div class="sec-ttl">YOUR HAND (<span id="handCnt">0</span>)</div>
        <div class="sec-acts">
          <button class="sbtn sbtn-blue" onclick="autoStage()">âœ¨ Auto</button>
          <button class="sbtn sbtn-red"  id="discardBtn" onclick="discardSelected()" disabled>ğŸ—‘ï¸ DISCARD</button>
        </div>
      </div>
      <div class="hand-cards" id="handCards"></div>
      <div class="hint" id="turnHint">â€”</div>
    </div>

  </div>
</div>

<!-- â•â•â•â•â•â•â•â• WIN SCREEN â•â•â•â•â•â•â•â• -->
<div id="winscreen" class="screen">
  <div class="trophy">ğŸ†</div>
  <div class="wt" id="winTitle">WINNER!</div>
  <div class="ws" id="winSub">â€”</div>
  <div class="rewards">
    <div class="rwrd"><span class="re">ğŸ¥‡</span><div class="ra" id="wG">+0</div><div class="rl">GOLD</div></div>
    <div class="rwrd"><span class="re">ğŸ€</span><div class="ra" id="wL">+0</div><div class="rl">LUCKY</div></div>
  </div>
  <div class="lb">
    <div class="lb-h">ğŸ“Š FINAL SCORES</div>
    <div id="lbRows"></div>
  </div>
  <div style="width:100%;max-width:340px;margin-top:8px;">
    <button class="btn btn-gold" onclick="toggleShop()" style="margin-bottom:8px;">ğŸ›’ VINTAGE SHOP</button>
    <button class="btn btn-dim"  onclick="backToLobby()">ğŸ”„ PLAY AGAIN</button>
  </div>
  <div class="shop-modal" id="shopModal">
    <div class="shop-ttl">ğŸ•¹ï¸ RARE VINTAGE SHOP</div>
    <div id="shopItems"></div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     JAVASCRIPT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// SOCKET
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const socket = io();
let myId = null;

socket.on('connect',       () => { myId = socket.id; pill('ok','â— LIVE'); });
socket.on('disconnect',    () => pill('bad','â— OFFLINE'));
socket.on('connect_error', () => pill('bad','â— ERROR'));

function pill(cls, txt) {
  const el = document.getElementById('connPill');
  el.className = cls; el.textContent = txt;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// CLIENT STATE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let roomCode = '';
let amHost   = false;
let myHand   = [], mySets = [[],[],[]], myLockedSets = 0, myLockedSetCards = [[],[],[]];
let hasDrawn = false, isMyTurn = false;
let selectedIdx = null, stagedCards = [];
let curState  = null;    // latest game_state
let timerInt  = null, timerSecs = 30;
let myGold = 0, myLucky = 0;
let targetBotCount = 0;  // for preset buttons

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// LOBBY ACTIONS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function hostGame() {
  const name = document.getElementById('nameIn').value.trim();
  if (!name) return notif('âš ï¸ Enter your name!');
  socket.emit('host_game', { playerName: name });
}
function joinGame() {
  const name = document.getElementById('nameIn').value.trim();
  const code = document.getElementById('codeIn').value.trim().toUpperCase();
  if (!name) return notif('âš ï¸ Enter your name!');
  if (!code) return notif('âš ï¸ Enter a room code!');
  socket.emit('join_game', { playerName: name, roomCode: code });
}
function leaveRoom() {
  socket.emit('leave_room');
}
function addBot()    { socket.emit('add_bot'); }
function removeBot() { socket.emit('remove_bot'); }
function startGame() { socket.emit('start_game'); }

function copyCode() {
  navigator.clipboard?.writeText(roomCode).catch(()=>{});
  notif(`ğŸ“‹ Room code copied: ${roomCode}`);
}
function copyLink() {
  const url = window.location.origin + '?room=' + roomCode;
  navigator.clipboard?.writeText(url).catch(()=>{});
  notif('ğŸ”— Link copied! Send it to friends.');
}

// Preset bot buttons
function setBots(target) {
  if (!amHost) return;
  const current = (curState?.players || []).filter(p => p.isBot).length;
  const diff = target - current;
  if (diff > 0) {
    // Add bots one at a time with slight delay so server can process
    let added = 0;
    const addNext = () => {
      if (added < diff) { socket.emit('add_bot'); added++; setTimeout(addNext, 150); }
    };
    addNext();
  } else if (diff < 0) {
    let removed = 0;
    const removeNext = () => {
      if (removed < Math.abs(diff)) { socket.emit('remove_bot'); removed++; setTimeout(removeNext, 150); }
    };
    removeNext();
  }
  // Highlight active preset
  document.querySelectorAll('.preset-btn').forEach((b,i) => {
    b.classList.toggle('active', i === target);
  });
}

// Pre-fill room code from URL ?room= param
window.addEventListener('load', () => {
  const params = new URLSearchParams(window.location.search);
  const r = params.get('room');
  if (r) document.getElementById('codeIn').value = r.toUpperCase();
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// SERVER â†’ CLIENT EVENTS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
socket.on('room_created', ({ roomCode: code }) => {
  roomCode = code; amHost = true;
  document.getElementById('dispCode').textContent = code;
  document.getElementById('shareUrl').textContent = window.location.origin + '?room=' + code;
  document.getElementById('startBtn').style.display = 'block';
  document.getElementById('waitMsg').style.display   = 'none';
  document.getElementById('botRow').classList.add('visible');
  document.getElementById('presetRow').style.display = 'flex';
  showScreen('waiting');
});

socket.on('room_joined', ({ roomCode: code }) => {
  roomCode = code; amHost = false;
  document.getElementById('dispCode').textContent = code;
  document.getElementById('shareUrl').textContent = window.location.origin + '?room=' + code;
  document.getElementById('startBtn').style.display = 'none';
  document.getElementById('waitMsg').style.display   = 'block';
  document.getElementById('botRow').classList.remove('visible');
  document.getElementById('presetRow').style.display = 'none';
  showScreen('waiting');
});

socket.on('you_are_host', () => {
  amHost = true;
  document.getElementById('startBtn').style.display = 'block';
  document.getElementById('waitMsg').style.display   = 'none';
  document.getElementById('botRow').classList.add('visible');
  document.getElementById('presetRow').style.display = 'flex';
  notif('ğŸ‘‘ You are now the host!');
});

// *** KEY FIX: dedicated lobby_update event ***
// This fires for EVERY lobby change: joins, leaves, bots added/removed
socket.on('lobby_update', (data) => {
  curState = data; // store so setBots() can read current bot count
  renderLobby(data);
});

socket.on('player_joined', ({ name, avatar, isBot }) => {
  notif(`${avatar} ${name}${isBot ? ' ğŸ¤–' : ''} joined the lobby!`);
});

socket.on('player_left', ({ name, avatar }) => {
  notif(`${avatar} ${name} left`);
});

socket.on('left_room', () => {
  resetState();
  showScreen('lobby');
});

socket.on('error', ({ message }) => notif(`âŒ ${message}`));

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// RENDER LOBBY â€” called on every lobby_update
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderLobby(data) {
  const grid  = document.getElementById('slotsGrid');
  const total = data.players.length;
  const maxSlots = 6;

  document.getElementById('lobbyCount').textContent = `${total} / ${maxSlots}`;

  // Update preset active state
  if (amHost) {
    const botCount = data.players.filter(p => p.isBot).length;
    document.querySelectorAll('.preset-btn').forEach((b,i) => {
      b.classList.toggle('active', i === botCount);
    });
  }

  let html = '';

  data.players.forEach((p, idx) => {
    const isYou  = p.id === myId;
    const isHost = p.id === data.hostId;
    const cls    = p.isBot ? 'bot' : isYou ? 'you' : 'human';

    let badgeHtml = '';
    let subHtml   = '';

    if (isHost && !p.isBot) {
      badgeHtml = '<span class="slot-badge badge-host">HOST</span>';
      subHtml   = `<div class="slot-sub host-tag">ğŸ‘‘ Host</div>`;
    } else if (p.isBot) {
      badgeHtml = '<span class="slot-badge badge-bot">ğŸ¤– BOT</span>';
      subHtml   = `<div class="slot-sub bot-tag">AI Player</div>`;
    } else if (isYou) {
      badgeHtml = '<span class="slot-badge badge-you">YOU</span>';
      subHtml   = `<div class="slot-sub you-tag">âœ“ Connected</div>`;
    } else {
      badgeHtml = '<span class="slot-badge badge-rdy">READY</span>';
      subHtml   = `<div class="slot-sub you-tag">âœ“ Connected</div>`;
    }

    html += `
      <div class="slot ${cls}" id="lobbySlot_${idx}">
        <div class="slot-av">${p.avatar}</div>
        <div class="slot-info">
          <div class="slot-name">${p.name}${isYou ? ' (You)' : ''}</div>
          ${subHtml}
        </div>
        ${badgeHtml}
      </div>`;
  });

  // Empty slots
  for (let i = total; i < maxSlots; i++) {
    html += `
      <div class="slot empty">
        <div class="slot-av" style="opacity:.2;">ğŸ‘¤</div>
        <div class="slot-info">
          <div class="slot-name" style="opacity:.2;">Empty Slot</div>
          <div class="slot-sub empty-tag">Waiting for playerâ€¦</div>
        </div>
      </div>`;
  }

  grid.innerHTML = html;

  // Quick pop animation on last filled slot
  const lastFilled = document.getElementById(`lobbySlot_${total - 1}`);
  if (lastFilled) {
    lastFilled.classList.remove('popped');
    void lastFilled.offsetWidth; // reflow
    lastFilled.classList.add('popped');
  }

  // Update start button state (need 2+ players to start)
  const startBtn = document.getElementById('startBtn');
  if (startBtn) {
    startBtn.disabled = total < 2;
    startBtn.textContent = total < 2
      ? 'âš ï¸ NEED 2+ PLAYERS'
      : `â–¶ START GAME (${total} players)`;
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// GAME STATE SYNC
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
socket.on('game_state', (state) => {
  curState = state;
  if (!document.getElementById('game').classList.contains('active')) return;
  renderGameState(state);
});

socket.on('game_started', () => {
  showScreen('game');
  banner('ğŸ® GAME START!');
});

socket.on('your_hand', ({ hand, sets, lockedSets, lockedSetCards, hasDrawn: hd }) => {
  myHand           = hand;
  mySets           = sets;
  myLockedSets     = lockedSets;
  myLockedSetCards = lockedSetCards;
  hasDrawn         = hd;  // â† this is the authoritative source of truth

  // Clear staged cards that are no longer in hand
  stagedCards = stagedCards.filter(sc =>
    myHand.some(c => c.id === sc.id && c.color === sc.color)
  );
  // Reset discard selection since hand changed
  selectedIdx = null;

  // Auto-detect complete sets now that hand is updated
  autoDetectSets();

  // Always update table state and hint here â€” this is what actually
  // unlocks the cards after a draw since hasDrawn just became true
  updateTableState();
  updateTurnHint();
  renderAll();
});

socket.on('set_locked', ({ slotIndex, lockedSets }) => {
  myLockedSets = lockedSets;
  stagedCards  = [];
  selectedIdx  = null;
  document.getElementById('lockCnt').textContent = lockedSets;
  notif(`ğŸ”’ Set ${slotIndex + 1} locked in! (${lockedSets}/3)`);
  renderAll();
});

socket.on('timer_start', ({ seconds, playerId }) => {
  isMyTurn = (playerId === myId);
  // Note: hasDrawn is managed only by your_hand events.
  // timer_start fires at turn-start AND after drawing â€” in both cases
  // your_hand arrives right after and does the definitive renderAll().
  // We just update the timer and table visual here.
  startTimerUI(seconds);
  updateTableState();
  updateTurnHint();
  updateButtons();
});

socket.on('card_drawn', ({ card, source }) => {
  // hasDrawn will be updated via your_hand â€” just show notification
  notif(`${card.emoji} ${card.name} drawn from ${source}!`, 1800);
});
socket.on('force_move',      () => notif('â° Time expired! Auto-move made.'));
socket.on('deck_reshuffled', () => notif('ğŸ”„ Deck reshuffled from discard pile!'));

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// AUTO-DETECT SETS IN HAND
// Finds the first valid set of 3 in the player's
// hand and pre-stages it so they just hit LOCK SET
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function autoDetectSets() {
  if (!isMyTurn || myLockedSets >= 3) return;
  if (stagedCards.length > 0) return; // don't override if player already staging

  const pool = myHand.map((c, i) => ({ ...c, _hi: i }));
  const byId    = {};
  const byColor = {};

  pool.forEach(c => {
    (byId[c.id]       = byId[c.id]       || []).push(c);
    (byColor[c.color] = byColor[c.color] || []).push(c);
  });

  // Try identical first, then same-color
  for (const group of [...Object.values(byId), ...Object.values(byColor)]) {
    if (group.length >= 3 && isValidSet(group.slice(0, 3))) {
      stagedCards = group.slice(0, 3);
      notif('âœ… Complete set detected in your hand! Tap LOCK SET to confirm.', 3000);
      return;
    }
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// RENDER ALL
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderAll() {
  renderHand();
  renderSets();
  renderStage();
  updateButtons();
  updateTurnHint();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// RENDER GAME STATE (from server broadcast)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderGameState(state) {
  if (!state) return;
  document.getElementById('rndNum').textContent  = state.round || 1;
  document.getElementById('deckCnt').textContent = `${state.deckCount} cards`;

  // Top discard pile card
  const dEl = document.getElementById('discardTop');
  if (state.topDiscard) {
    const d = state.topDiscard;
    dEl.className = `card card-${d.color}`;
    dEl.innerHTML = `<div class="cem">${d.emoji}</div><div class="cnm">${d.name}</div>`;
  } else {
    dEl.className = 'card';
    dEl.innerHTML = '<div class="cem">â™»ï¸</div><div class="cnm" style="color:rgba(255,255,255,.3);">Empty</div>';
  }

  // Turn badge
  const cur    = state.players[state.currentTurn];
  const myTurn = cur && cur.id === myId;
  const tb     = document.getElementById('turnBadge');
  if (myTurn) {
    tb.textContent = 'âš¡ YOUR TURN'; tb.style.color = 'var(--green)';
  } else if (cur) {
    tb.textContent = `${cur.avatar} ${cur.name}`; tb.style.color = 'rgba(255,255,255,.45)';
  }

  // My stats
  const me = state.players.find(p => p.id === myId);
  if (me) {
    document.getElementById('goldCnt').textContent  = me.gold;
    document.getElementById('luckyCnt').textContent = me.lucky;
    document.getElementById('lockCnt').textContent  = me.lockedSets;
  }

  renderOpponents(state);
}

function renderOpponents(state) {
  const row = document.getElementById('oppRow');
  row.innerHTML = '';
  state.players.forEach((p, i) => {
    if (p.id === myId) return;
    const active = state.currentTurn === i;
    const div = document.createElement('div');
    div.className = `ocard${active ? ' cur' : ''}`;
    const peekHtml = p.discardPile?.length
      ? p.discardPile.slice(-6).map(c => `<div class="mpcard card-${c.color}">${c.emoji}</div>`).join('')
      : '<div style="font-size:10px;color:rgba(255,255,255,.22);">Empty</div>';
    div.innerHTML = `
      <div class="oav">${p.avatar}${p.isBot ? '<sup style="font-size:8px;">ğŸ¤–</sup>' : ''}</div>
      <div class="oname">${p.name}</div>
      <div class="oinfo">ğŸƒ ${p.cardCount}</div>
      ${p.lockedSets > 0 ? `<div class="osets">ğŸ”’ ${p.lockedSets}/3</div>` : ''}
      <div class="peek">
        <div class="peek-ttl">${p.name}'s DISCARD</div>
        <div class="peek-cards">${peekHtml}</div>
      </div>`;
    row.appendChild(div);
  });
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// RENDER HAND
// Cards are greyed out before drawing.
// After drawing: tap once = SELECT (gold border,
// enables DISCARD button). Tap selected again =
// move to stage. Tap staged card = remove from stage.
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderHand() {
  const container = document.getElementById('handCards');
  container.innerHTML = '';
  document.getElementById('handCnt').textContent = myHand.length;

  myHand.forEach((card, i) => {
    const isSelected = selectedIdx === i;
    const isStaged   = stagedCards.some(s => s._hi === i);
    const interactive = isMyTurn && hasDrawn && !isStaged;

    const el = document.createElement('div');
    el.className = [
      'card',
      `card-${card.color}`,
      interactive   ? 'hov'    : '',
      isSelected    ? 'sel'    : '',
      isStaged      ? 'staged' : '',
      (!isMyTurn || !hasDrawn) ? 'off' : '',
    ].filter(Boolean).join(' ');

    el.innerHTML = `<div class="cem">${card.emoji}</div><div class="cnm">${card.name}</div>`;

    if (interactive) {
      el.onclick = () => handleCardTap(i);
    } else if (isStaged) {
      // Staged cards are tappable to remove them
      el.classList.remove('off');
      el.onclick = () => {
        const si = stagedCards.findIndex(s => s._hi === i);
        if (si !== -1) { stagedCards.splice(si, 1); renderAll(); }
      };
    }

    container.appendChild(el);
  });
}

function renderSets() {
  for (let i = 0; i < 3; i++) {
    const slot   = document.getElementById(`set${i}`);
    const locked = myLockedSetCards[i]?.length === 3;
    if (locked) {
      slot.className = 'set-slot lk';
      slot.innerHTML = `<span class="slbl">ğŸ”’ SET ${i + 1}</span>` +
        myLockedSetCards[i].map(c =>
          `<div class="card card-${c.color} locked-c" style="width:44px;height:62px;">
            <div class="cem" style="font-size:16px;">${c.emoji}</div>
            <div class="cnm" style="font-size:6px;">${c.name}</div>
          </div>`).join('');
    } else {
      slot.className = 'set-slot';
      slot.innerHTML = `<span class="slbl">SET ${i + 1}</span><div class="plus-hint">+</div>`;
    }
  }
  document.getElementById('lockCnt').textContent = myLockedSets;
}

function renderStage() {
  const container = document.getElementById('stageCards');
  const emptyHint = document.getElementById('stageEmpty');
  const statEl    = document.getElementById('stageStat');

  if (stagedCards.length === 0) {
    container.innerHTML   = '';
    emptyHint.style.display = 'block';
    statEl.textContent    = '';
    return;
  }

  emptyHint.style.display = 'none';
  container.innerHTML = stagedCards.map((card, i) =>
    `<div class="card card-${card.color} staged" style="width:58px;height:82px;cursor:pointer;" onclick="unstage(${i})">
      <div class="cem" style="font-size:20px;">${card.emoji}</div>
      <div class="cnm" style="font-size:6px;">${card.name}</div>
    </div>`
  ).join('');

  if (stagedCards.length < 3) {
    statEl.textContent = `${stagedCards.length}/3 cards â€” need ${3 - stagedCards.length} more`;
    statEl.style.color = 'var(--muted)';
  } else {
    const valid = isValidSet(stagedCards);
    statEl.textContent = valid
      ? 'âœ… Valid set! Hit LOCK SET to confirm.'
      : 'âŒ Not a valid set â€” need 3 identical OR 3 same-color consoles';
    statEl.style.color = valid ? 'var(--green)' : 'var(--red)';
  }
}

function updateTurnHint() {
  const h = document.getElementById('turnHint');
  if (!isMyTurn) {
    const cur = curState?.players[curState?.currentTurn];
    h.textContent = cur ? `â³ Waiting for ${cur.avatar} ${cur.name}â€¦` : 'â³ Waitingâ€¦';
    return;
  }
  if (!hasDrawn) {
    h.textContent = 'ğŸ‘† Draw a card from the DECK or DISCARD PILE to begin your turn';
  } else {
    h.textContent = 'ğŸ‘† Tap a card once to SELECT it â†’ DISCARD to end turn  Â·  Tap a selected card again to STAGE it for a set â†’ LOCK SET';
  }
}

function updateButtons() {
  // DISCARD: need my turn, already drew, and have a card selected
  const canDiscard = isMyTurn && hasDrawn && selectedIdx !== null;
  // LOCK SET: need 3 valid staged cards and an open slot
  const canLock    = stagedCards.length === 3 && isValidSet(stagedCards) && myLockedSets < 3;

  document.getElementById('discardBtn').disabled  = !canDiscard;
  document.getElementById('lockStBtn').disabled   = !canLock;
  document.getElementById('clearStBtn').disabled  = stagedCards.length === 0;

  // Visual feedback on discard button when ready
  const db = document.getElementById('discardBtn');
  if (canDiscard) {
    db.style.background = 'rgba(255,23,68,.25)';
    db.style.borderColor = 'rgba(255,23,68,.6)';
    db.style.color = '#ff4444';
  } else {
    db.style.background = '';
    db.style.borderColor = '';
    db.style.color = '';
  }
}

function updateTableState() {
  const canDraw = isMyTurn && !hasDrawn;
  const dk = document.getElementById('deckCard');
  const dd = document.getElementById('discardTop');
  if (canDraw) {
    dk.classList.add('pulse');    dk.classList.remove('off');
    dd.classList.remove('off');
  } else {
    dk.classList.remove('pulse'); dk.classList.add('off');
    dd.classList.add('off');
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// CARD TAP HANDLER
// Tap 1: SELECT card (gold highlight, DISCARD enabled)
// Tap 2 (same card): STAGE it for set building
// Tap staged card: REMOVE from stage
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function handleCardTap(idx) {
  if (!isMyTurn || !hasDrawn) return;

  if (selectedIdx === idx) {
    // Second tap on same card â†’ move it to stage area
    if (stagedCards.length < 3) {
      stagedCards.push({ ...myHand[idx], _hi: idx });
    }
    selectedIdx = null;
  } else {
    // First tap â†’ select this card (deselect previous)
    selectedIdx = idx;
  }

  renderAll();
}

function unstage(stageIdx) {
  stagedCards.splice(stageIdx, 1);
  renderAll();
}

function clearStage() {
  stagedCards = [];
  selectedIdx = null;
  renderAll();
}

// Auto-stage: find best set and stage it for the player
function autoStage() {
  if (myLockedSets >= 3) return;
  const pool = myHand.map((c, i) => ({ ...c, _hi: i }));
  const byId = {}, byColor = {};
  pool.forEach(c => {
    (byId[c.id]       = byId[c.id]       || []).push(c);
    (byColor[c.color] = byColor[c.color] || []).push(c);
  });
  for (const group of [...Object.values(byId), ...Object.values(byColor)]) {
    if (group.length >= 3 && isValidSet(group.slice(0, 3))) {
      stagedCards = group.slice(0, 3);
      selectedIdx = null;
      renderAll();
      notif('âœ¨ Complete set staged! Tap LOCK SET to confirm.', 2500);
      return;
    }
  }
  notif('No complete set in hand yet â€” keep drawing!', 2200);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ACTIONS â†’ SERVER
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawDeck() {
  if (!isMyTurn || hasDrawn) return;
  socket.emit('draw_deck');
}

function drawDiscard() {
  if (!isMyTurn || hasDrawn) return;
  socket.emit('draw_discard');
}

function discardSelected() {
  if (!isMyTurn || !hasDrawn || selectedIdx === null) return;
  const idx = selectedIdx;
  selectedIdx = null;
  socket.emit('discard_card', { handIndex: idx });
}

function lockStage() {
  if (stagedCards.length !== 3 || !isValidSet(stagedCards) || myLockedSets >= 3) return;

  // Find first open slot
  let slot = -1;
  for (let i = 0; i < 3; i++) {
    if (!myLockedSetCards[i] || myLockedSetCards[i].length === 0) { slot = i; break; }
  }
  if (slot === -1) return notif('All set slots are full!');

  // Strip the local _hi helper before sending to server
  const cards = stagedCards.map(({ _hi, ...c }) => c);
  socket.emit('lock_set', { slotIndex: slot, cards });
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// TIMER UI
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startTimerUI(secs) {
  stopTimerUI(); timerSecs = secs; setTimer(secs);
  timerInt = setInterval(() => { setTimer(--timerSecs); if (timerSecs <= 0) stopTimerUI(); }, 1000);
}
function stopTimerUI() { if (timerInt) { clearInterval(timerInt); timerInt = null; } }
function setTimer(s) {
  const f = document.getElementById('timerFill');
  const n = document.getElementById('timerNum');
  const p = Math.max(0, (s/30)*100);
  const c = s > 20 ? 'var(--green)' : s > 10 ? 'var(--yellow)' : 'var(--red)';
  f.style.width = p + '%'; f.style.background = c;
  n.textContent = Math.max(0, s); n.style.color = c;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// WIN
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
socket.on('game_over', ({ winner, goldEarned, luckyEarned, finalScores }) => {
  stopTimerUI();
  const isW = winner.id === myId;
  if (isW) { myGold += goldEarned; myLucky += luckyEarned; }
  setTimeout(() => {
    showScreen('winscreen');
    document.getElementById('winTitle').textContent = isW ? 'ğŸ† YOU WIN!' : `${winner.avatar} ${winner.name} WINS!`;
    document.getElementById('winSub').textContent   = isW ? 'ğŸ‰ Congratulations!' : 'Better luck next time!';
    document.getElementById('wG').textContent = `+${isW ? goldEarned : 0}`;
    document.getElementById('wL').textContent = `+${isW ? luckyEarned : 0}`;
    const medals = ['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰','4','5','6'];
    document.getElementById('lbRows').innerHTML = finalScores.map((p,i) =>
      `<div class="lbr${p.id===winner.id?' win':''}">
        <div class="lpos">${medals[i]||i+1}</div>
        <div class="lav">${p.avatar}</div>
        <div class="lnm">${p.name}${p.id===myId?' (You)':''}${p.isBot?' ğŸ¤–':''}</div>
        <div class="lsc">ğŸ”’${p.lockedSets} sets Â· ğŸ¥‡${p.gold}</div>
      </div>`).join('');
    if (isW) confetti();
    renderShop();
  }, 600);
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// UTILITIES
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function isValidSet(cards) {
  if (!cards || cards.length !== 3) return false;
  return cards.every(c => c.id    === cards[0].id)
      || cards.every(c => c.color === cards[0].color);
}

function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

function resetState() {
  roomCode=''; amHost=false;
  myHand=[]; mySets=[[],[],[]]; myLockedSets=0; myLockedSetCards=[[],[],[]];
  hasDrawn=false; isMyTurn=false; selectedIdx=null; stagedCards=[]; curState=null;
  stopTimerUI();
  document.getElementById('botRow').classList.remove('visible');
  document.getElementById('presetRow').style.display = 'none';
  document.getElementById('startBtn').style.display  = 'none';
  document.getElementById('waitMsg').style.display   = 'block';
}

let notifT;
function notif(msg, dur=2400) {
  document.querySelector('.notif')?.remove();
  const el = document.createElement('div');
  el.className = 'notif'; el.textContent = msg;
  document.body.appendChild(el);
  clearTimeout(notifT);
  notifT = setTimeout(() => el.remove(), dur);
}

let bannerT;
function banner(msg) {
  document.querySelector('.banner')?.remove();
  const el = document.createElement('div');
  el.className = 'banner'; el.textContent = msg;
  document.body.appendChild(el);
  clearTimeout(bannerT);
  bannerT = setTimeout(() => el.remove(), 2200);
}

function confetti() {
  const cols = ['#ffd700','#ff1744','#00e676','#448aff','#ff6d00','#e040fb','#00ffff','#fff'];
  for (let i=0;i<70;i++) setTimeout(()=>{
    const el=document.createElement('div');
    el.className='cfp';
    el.style.left=Math.random()*100+'vw';
    el.style.background=cols[Math.floor(Math.random()*cols.length)];
    el.style.animationDuration=(1.5+Math.random()*2.5)+'s';
    document.body.appendChild(el);
    setTimeout(()=>el.remove(),5000);
  }, Math.random()*1200);
}

function backToLobby() {
  document.getElementById('shopModal').style.display='none';
  resetState(); showScreen('lobby');
}
function toggleShop() {
  const m = document.getElementById('shopModal');
  m.style.display = m.style.display==='none'?'block':'none';
}

// Shop
const SHOP=[
  {emoji:'ğŸ•¹ï¸',name:'Atari 2600',   price:50, rarity:'ğŸŒŸ Rare'},
  {emoji:'ğŸ“º',name:'Vectrex',       price:80, rarity:'ğŸ’ Epic'},
  {emoji:'ğŸ®',name:'Virtual Boy',   price:65, rarity:'ğŸŒŸ Rare'},
  {emoji:'ğŸ‘¾',name:'ColecoVision',  price:45, rarity:'âœ¨ Uncommon'},
  {emoji:'ğŸ’¾',name:'3DO Interactive',price:90,rarity:'ğŸ’ Epic'},
  {emoji:'ğŸŒ€',name:'Jaguar CD',     price:120,rarity:'ğŸ”¥ Legendary'},
  {emoji:'ğŸ†',name:'Neo Geo Gold',  price:150,rarity:'ğŸ”¥ Legendary'},
];
function renderShop() {
  document.getElementById('shopItems').innerHTML = SHOP.map(it=>
    `<div class="si">
      <div class="si-e">${it.emoji}</div>
      <div class="si-i"><div class="si-n">${it.name}</div><div class="si-r">${it.rarity}</div></div>
      <button class="si-b" onclick="buyItem('${it.name}',${it.price})">ğŸ€${it.price}</button>
    </div>`).join('');
}
function buyItem(name, price) {
  if (myLucky < price) return notif(`âŒ Need ${price} Lucky Coins!`);
  myLucky -= price; notif(`ğŸ‰ Purchased ${name}!`);
}

// Keyboard shortcuts
document.addEventListener('keydown', e => {
  if (e.key==='Enter') {
    if (document.getElementById('lobby').classList.contains('active'))
      document.getElementById('codeIn').value.trim() ? joinGame() : hostGame();
  }
});

renderShop();
</script>
</body>
</html>
