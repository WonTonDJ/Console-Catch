<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Console Catch ğŸ®</title>
<script src="/socket.io/socket.io.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Orbitron:wght@400;700;900&family=Rajdhani:wght@400;600;700&display=swap');

:root {
  --bg:#0a0a0f; --surface:#13131e; --surface2:#1c1c2a; --surface3:#242436;
  --text:#e8e8ff; --muted:rgba(200,200,255,0.4);
  --gold:#ffd700; --lucky:#00ffff;
  --green:#00e676; --red:#ff1744; --yellow:#ffea00; --blue:#448aff; --orange:#ff6d00;
  --beige:#f5deb3; --grey:#9e9e9e;
  --radius:12px;
}
*{margin:0;padding:0;box-sizing:border-box;}
html,body{height:100%;}
body{
  font-family:'Rajdhani',sans-serif;
  background:var(--bg); color:var(--text);
  min-height:100vh; overflow-x:hidden;
  user-select:none; -webkit-tap-highlight-color:transparent;
}
body::before{
  content:''; position:fixed; inset:0; pointer-events:none; z-index:9999;
  background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,0,0,0.06) 2px,rgba(0,0,0,0.06) 4px);
}

/* â”€â”€ SCREENS â”€â”€ */
.screen{display:none;min-height:100vh;flex-direction:column;align-items:center;}
.screen.active{display:flex;}

/* â”€â”€ CONNECTION DOT â”€â”€ */
#connDot{
  position:fixed;top:10px;right:12px;z-index:500;
  font-family:'Orbitron',sans-serif;font-size:9px;letter-spacing:1px;
  padding:4px 10px;border-radius:20px;transition:all .3s;
}
#connDot.ok{background:rgba(0,230,118,.12);color:var(--green);border:1px solid rgba(0,230,118,.3);}
#connDot.bad{background:rgba(255,23,68,.12);color:var(--red);border:1px solid rgba(255,23,68,.3);}
#connDot.wait{background:rgba(255,234,0,.12);color:var(--yellow);border:1px solid rgba(255,234,0,.3);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LOBBY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#lobby{
  background:radial-gradient(ellipse at 30% 20%,#1a0533,var(--bg) 60%),
             radial-gradient(ellipse at 80% 80%,#001a3a,transparent 50%);
  padding:24px 20px; justify-content:center; gap:0;
}
.logo{text-align:center;margin-bottom:28px;}
.logo h1{
  font-family:'Press Start 2P',monospace;
  font-size:clamp(16px,5vw,30px);
  color:var(--gold);
  text-shadow:0 0 20px rgba(255,215,0,.6),4px 4px 0 #8B6914;
  animation:glow 2s ease-in-out infinite alternate;
  line-height:1.5;
}
.logo p{font-family:'Orbitron',sans-serif;font-size:10px;color:var(--muted);margin-top:10px;letter-spacing:3px;}
@keyframes glow{
  from{text-shadow:0 0 20px rgba(255,215,0,.6),4px 4px 0 #8B6914;}
  to{text-shadow:0 0 50px rgba(255,215,0,1),0 0 100px rgba(255,165,0,.4),4px 4px 0 #8B6914;}
}

.parade{display:flex;gap:7px;justify-content:center;margin-bottom:24px;flex-wrap:wrap;max-width:340px;}
.parade-card{
  width:36px;height:50px;border-radius:6px;border:2px solid rgba(255,255,255,.15);
  display:flex;align-items:center;justify-content:center;font-size:17px;
  animation:float 3s ease-in-out infinite;
}
.parade-card:nth-child(2){animation-delay:.3s}.parade-card:nth-child(3){animation-delay:.6s}
.parade-card:nth-child(4){animation-delay:.9s}.parade-card:nth-child(5){animation-delay:1.2s}
.parade-card:nth-child(6){animation-delay:1.5s}.parade-card:nth-child(7){animation-delay:1.8s}
@keyframes float{0%,100%{transform:translateY(0) rotate(-3deg);}50%{transform:translateY(-8px) rotate(3deg);}}

.card-box{
  background:var(--surface);border:1px solid rgba(255,255,255,.08);
  border-radius:var(--radius);padding:22px;width:100%;max-width:380px;
  box-shadow:0 0 60px rgba(0,0,0,.5);
}
.field{margin-bottom:14px;}
.field label{display:block;font-family:'Orbitron',sans-serif;font-size:9px;letter-spacing:2px;color:var(--muted);margin-bottom:7px;}
.field input{
  width:100%;background:var(--surface2);border:1px solid rgba(255,255,255,.12);
  border-radius:8px;padding:11px 14px;color:var(--text);
  font-family:'Rajdhani',sans-serif;font-size:16px;font-weight:700;outline:none;
  transition:border-color .2s,box-shadow .2s;
}
.field input:focus{border-color:var(--gold);box-shadow:0 0 14px rgba(255,215,0,.15);}
.divider{text-align:center;color:rgba(255,255,255,.2);font-size:10px;letter-spacing:3px;margin:14px 0;font-family:'Orbitron',sans-serif;}

/* â”€â”€ BUTTONS â”€â”€ */
.btn{
  width:100%;padding:13px;border:none;border-radius:10px;
  font-family:'Press Start 2P',monospace;font-size:10px;
  cursor:pointer;transition:all .15s;letter-spacing:1px;
  position:relative;overflow:hidden;
}
.btn::after{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;
  background:linear-gradient(90deg,transparent,rgba(255,255,255,.12),transparent);transition:left .35s;}
.btn:hover:not(:disabled)::after{left:100%;}
.btn:active:not(:disabled){transform:scale(.97);}
.btn:disabled{opacity:.35;cursor:not-allowed;}
.btn-gold{background:linear-gradient(135deg,#ffd700,#ff8c00);color:#000;box-shadow:0 4px 18px rgba(255,150,0,.35);margin-bottom:10px;}
.btn-gold:hover:not(:disabled){box-shadow:0 6px 28px rgba(255,180,0,.55);}
.btn-dim{background:var(--surface2);color:var(--text);border:1px solid rgba(255,255,255,.14);}
.btn-sm{
  padding:7px 12px;border:none;border-radius:8px;
  font-family:'Orbitron',sans-serif;font-size:9px;letter-spacing:1px;
  cursor:pointer;transition:all .15s;
}
.btn-sm:active{transform:scale(.95);}
.btn-sm:disabled{opacity:.3;cursor:not-allowed;}
.btn-green{background:rgba(0,230,118,.15);color:var(--green);border:1px solid rgba(0,230,118,.3);}
.btn-green:hover:not(:disabled){background:rgba(0,230,118,.25);}
.btn-red{background:rgba(255,23,68,.12);color:#ff6b6b;border:1px solid rgba(255,23,68,.3);}
.btn-red:hover:not(:disabled){background:rgba(255,23,68,.22);}
.btn-blue{background:rgba(68,138,255,.15);color:var(--blue);border:1px solid rgba(68,138,255,.3);}
.btn-blue:hover:not(:disabled){background:rgba(68,138,255,.25);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   WAITING ROOM
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#waiting{background:var(--bg);padding:20px;justify-content:flex-start;gap:14px;padding-top:24px;}

.back-btn{
  align-self:flex-start;
  background:var(--surface2);border:1px solid rgba(255,255,255,.12);border-radius:8px;
  padding:7px 14px;font-family:'Orbitron',sans-serif;font-size:9px;letter-spacing:1px;
  color:var(--muted);cursor:pointer;transition:all .15s;
}
.back-btn:hover{color:var(--text);border-color:rgba(255,255,255,.3);}

.room-code-box{
  display:flex;align-items:center;justify-content:center;gap:10px;
  background:var(--surface);border:1px solid rgba(255,255,255,.08);
  border-radius:var(--radius);padding:12px 16px;width:100%;max-width:440px;
}
.room-code-box span{font-family:'Orbitron',sans-serif;font-size:10px;color:var(--muted);letter-spacing:2px;}
.room-code-box strong{font-family:'Press Start 2P',monospace;font-size:16px;color:var(--lucky);letter-spacing:5px;}
.copy-icon{font-size:18px;cursor:pointer;transition:transform .15s;}
.copy-icon:hover{transform:scale(1.2);}

/* Players in lobby */
.lobby-players{
  width:100%;max-width:440px;
  background:var(--surface);border:1px solid rgba(255,255,255,.07);
  border-radius:var(--radius);overflow:hidden;
}
.lobby-players-header{
  display:flex;align-items:center;justify-content:space-between;
  padding:10px 14px;border-bottom:1px solid rgba(255,255,255,.06);
  font-family:'Orbitron',sans-serif;font-size:9px;letter-spacing:2px;color:var(--muted);
}
.player-row{
  display:flex;align-items:center;gap:10px;
  padding:10px 14px;border-bottom:1px solid rgba(255,255,255,.04);
  transition:background .2s;
}
.player-row:last-child{border-bottom:none;}
.player-row.you{background:rgba(255,215,0,.04);}
.player-row .pav{font-size:22px;}
.player-row .pname{flex:1;font-size:14px;font-weight:700;}
.player-row .ptag{
  font-family:'Orbitron',sans-serif;font-size:8px;letter-spacing:1px;
  padding:3px 7px;border-radius:10px;
}
.ptag-host{background:rgba(255,215,0,.15);color:var(--gold);border:1px solid rgba(255,215,0,.3);}
.ptag-bot{background:rgba(68,138,255,.12);color:var(--blue);border:1px solid rgba(68,138,255,.3);}
.ptag-ready{background:rgba(0,230,118,.1);color:var(--green);border:1px solid rgba(0,230,118,.2);}
.empty-row{
  padding:10px 14px;font-family:'Orbitron',sans-serif;
  font-size:9px;color:rgba(255,255,255,.15);letter-spacing:1px;text-align:center;
}

.bot-controls{display:flex;gap:8px;width:100%;max-width:440px;}

.waiting-actions{width:100%;max-width:440px;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GAME
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#game{
  background:radial-gradient(ellipse at 50% 0%,#0d1a2e,var(--bg) 60%);
  flex-direction:column;min-height:100vh;
}

/* Header */
.game-header{
  background:var(--surface);border-bottom:1px solid rgba(255,255,255,.07);
  padding:8px 14px;display:flex;align-items:center;justify-content:space-between;
  position:sticky;top:0;z-index:100;
}
.hchip{
  display:flex;align-items:center;gap:4px;
  background:var(--surface2);border-radius:20px;padding:4px 10px;
  font-family:'Orbitron',sans-serif;font-size:11px;font-weight:700;
}
.hchip.gold{color:var(--gold);border:1px solid rgba(255,215,0,.2);}
.hchip.lucky{color:var(--lucky);border:1px solid rgba(0,255,255,.2);}
.hchip.rnd{color:rgba(255,255,255,.5);border:1px solid rgba(255,255,255,.08);}
.turn-badge{
  font-family:'Press Start 2P',monospace;font-size:7px;
  text-align:center;line-height:1.7;max-width:140px;
}

/* Big visual timer */
.timer-wrap{
  display:flex;align-items:center;gap:0;
  background:var(--surface2);
  border-bottom:1px solid rgba(255,255,255,.05);
}
.timer-bar{flex:1;height:6px;background:rgba(255,255,255,.06);}
.timer-fill{height:100%;width:100%;transition:width 1s linear,background .5s;}
.timer-countdown{
  font-family:'Press Start 2P',monospace;font-size:11px;
  min-width:46px;text-align:center;padding:4px 8px;
  transition:color .3s;
}

/* Main layout */
.game-main{
  flex:1;padding:10px;display:flex;flex-direction:column;gap:10px;
  max-width:620px;width:100%;margin:0 auto;
}

/* Opponents */
.opp-row{display:flex;gap:7px;overflow-x:auto;padding-bottom:2px;}
.opp-card{
  background:var(--surface);border:1px solid rgba(255,255,255,.07);
  border-radius:10px;padding:7px 10px;flex-shrink:0;min-width:86px;text-align:center;
  position:relative;cursor:pointer;transition:all .2s;
}
.opp-card:hover{border-color:rgba(255,255,255,.25);}
.opp-card.myturn{border-color:var(--green);box-shadow:0 0 14px rgba(0,230,118,.25);}
.opp-av{font-size:20px;}
.opp-name{font-size:10px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:76px;margin-top:2px;}
.opp-info{font-size:8px;color:var(--muted);font-family:'Orbitron',sans-serif;margin-top:2px;}
.opp-sets-done{font-size:9px;color:var(--green);margin-top:1px;}

/* Discard peek */
.peek-popup{
  display:none;position:absolute;top:calc(100% + 6px);left:50%;transform:translateX(-50%);
  background:#1e1e2e;border:1px solid rgba(255,255,255,.15);border-radius:10px;
  padding:10px;z-index:60;min-width:160px;box-shadow:0 10px 30px rgba(0,0,0,.6);
}
.opp-card:hover .peek-popup{display:block;}
.peek-title{font-family:'Orbitron',sans-serif;font-size:8px;letter-spacing:2px;color:var(--muted);margin-bottom:6px;}
.peek-cards{display:flex;flex-wrap:wrap;gap:3px;}

/* Table */
.table-center{
  background:var(--surface);border:1px solid rgba(255,255,255,.07);
  border-radius:14px;padding:14px;display:flex;gap:14px;align-items:center;justify-content:center;
}
.pile-sec{text-align:center;flex:1;}
.pile-lbl{font-family:'Orbitron',sans-serif;font-size:8px;letter-spacing:2px;color:var(--muted);margin-bottom:7px;}
.deck-count{font-family:'Press Start 2P',monospace;font-size:7px;color:rgba(255,255,255,.25);margin-top:5px;}
.table-sep{font-size:22px;opacity:.18;}

/* Cards */
.card{
  width:68px;height:96px;border-radius:9px;
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  cursor:pointer;transition:transform .18s,box-shadow .18s;
  position:relative;border:2px solid rgba(255,255,255,.12);flex-shrink:0;
}
.card:active{transform:scale(.95)!important;}
.card.hoverable:hover{transform:translateY(-5px) scale(1.04);}
.card.selected{transform:translateY(-10px) scale(1.07)!important;border-color:var(--gold)!important;box-shadow:0 10px 28px rgba(255,215,0,.5)!important;}
.card.staged{transform:translateY(-5px);border-color:rgba(0,230,118,.7)!important;box-shadow:0 6px 18px rgba(0,230,118,.35)!important;}
.card.locked-card{cursor:default;opacity:.85;}
.card.disabled{opacity:.4;cursor:not-allowed;}
.card.pulse{animation:cpulse 1.5s infinite;}
@keyframes cpulse{0%,100%{box-shadow:0 0 0 0 rgba(0,230,118,.5);}50%{box-shadow:0 0 0 10px rgba(0,230,118,0);}}

.card-back{background:linear-gradient(135deg,#1a1a2e,#16213e);border:2px solid rgba(100,100,200,.22);}
.card-back::before{
  content:'';position:absolute;inset:4px;border:1px solid rgba(255,255,255,.04);border-radius:5px;
  background:repeating-linear-gradient(45deg,transparent,transparent 4px,rgba(255,255,255,.025) 4px,rgba(255,255,255,.025) 8px);
}
.cem{font-size:24px;margin-bottom:3px;position:relative;z-index:1;}
.cname{font-size:7px;font-weight:700;text-align:center;padding:0 3px;position:relative;z-index:1;line-height:1.2;font-family:'Rajdhani',sans-serif;}

.card-beige{background:linear-gradient(145deg,#f5deb3,#e0c07a);} .card-beige .cname{color:rgba(0,0,0,.7);}
.card-green{background:linear-gradient(145deg,#00e676,#009945);} .card-green .cname{color:rgba(255,255,255,.9);}
.card-blue{background:linear-gradient(145deg,#5c9fff,#1a5fcc);}  .card-blue .cname{color:rgba(255,255,255,.9);}
.card-yellow{background:linear-gradient(145deg,#ffea00,#d4b800);}  .card-yellow .cname{color:rgba(0,0,0,.75);}
.card-orange{background:linear-gradient(145deg,#ff6d00,#c43c00);}  .card-orange .cname{color:rgba(255,255,255,.9);}
.card-grey{background:linear-gradient(145deg,#a0a0a0,#606060);}  .card-grey .cname{color:rgba(255,255,255,.9);}
.card-red{background:linear-gradient(145deg,#ff3355,#aa0022);}   .card-red .cname{color:rgba(255,255,255,.9);}

/* Section boxes */
.sec{background:var(--surface);border:1px solid rgba(255,255,255,.07);border-radius:14px;padding:11px;}
.sec-hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;}
.sec-title{font-family:'Orbitron',sans-serif;font-size:10px;letter-spacing:2px;color:var(--muted);}
.sec-actions{display:flex;gap:6px;align-items:center;}

/* Hand */
.hand-cards{display:flex;gap:5px;overflow-x:auto;padding-bottom:3px;flex-wrap:wrap;justify-content:center;}
.turn-hint{font-family:'Orbitron',sans-serif;font-size:8px;color:rgba(255,255,255,.22);text-align:center;margin-top:7px;letter-spacing:1px;line-height:1.5;}

/* Sets area */
.sets-row{display:flex;gap:8px;}
.set-slot{
  flex:1;border:2px dashed rgba(255,255,255,.1);border-radius:10px;
  padding:7px;min-height:82px;display:flex;gap:3px;align-items:center;
  justify-content:center;position:relative;transition:all .2s;flex-wrap:wrap;
}
.set-slot.valid-pending{border-color:var(--green);background:rgba(0,230,118,.05);}
.set-slot.locked{border-color:var(--gold);background:rgba(255,215,0,.06);box-shadow:0 0 14px rgba(255,215,0,.18);}
.set-slot .slot-lbl{
  position:absolute;top:-9px;left:9px;
  font-family:'Orbitron',sans-serif;font-size:7px;letter-spacing:1px;
  color:rgba(255,255,255,.22);background:var(--surface);padding:0 4px;
}
.set-slot.locked .slot-lbl{color:var(--gold);}
.set-slot.valid-pending .slot-lbl{color:var(--green);}
.lock-btn{
  position:absolute;bottom:-14px;left:50%;transform:translateX(-50%);
  background:linear-gradient(135deg,#ffd700,#ff8c00);border:none;border-radius:6px;
  padding:4px 10px;font-family:'Press Start 2P',monospace;font-size:7px;
  cursor:pointer;color:#000;white-space:nowrap;z-index:10;
  animation:lockPulse 1s infinite;
}
@keyframes lockPulse{0%,100%{box-shadow:0 0 0 0 rgba(255,215,0,.5);}50%{box-shadow:0 0 0 6px rgba(255,215,0,0);}}
.set-slot .plus-hint{font-size:18px;opacity:.12;}

/* Stage area */
.stage-area{
  background:var(--surface2);border:2px dashed rgba(0,230,118,.2);
  border-radius:10px;padding:10px;margin-bottom:4px;
}
.stage-hdr{
  display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;
}
.stage-title{font-family:'Orbitron',sans-serif;font-size:9px;letter-spacing:2px;color:rgba(0,230,118,.7);}
.stage-cards{display:flex;gap:5px;flex-wrap:wrap;min-height:40px;align-items:center;}
.stage-hint{font-size:10px;color:rgba(0,230,118,.3);font-family:'Orbitron',sans-serif;font-size:8px;letter-spacing:1px;}

/* Mini discard peek cards */
.mpcard{
  width:26px;height:36px;border-radius:3px;
  display:flex;align-items:center;justify-content:center;
  font-size:13px;border:1px solid rgba(255,255,255,.15);
}

/* â”€â”€ Notifications â”€â”€ */
.notif{
  position:fixed;top:60px;left:50%;transform:translateX(-50%);
  background:rgba(15,15,25,.97);border:1px solid rgba(255,255,255,.14);
  border-radius:12px;padding:10px 18px;
  font-family:'Press Start 2P',monospace;font-size:9px;
  z-index:300;max-width:300px;text-align:center;line-height:1.7;
  animation:npop .25s ease-out;pointer-events:none;
}
@keyframes npop{from{transform:translateX(-50%) scale(.75);opacity:0;}to{transform:translateX(-50%) scale(1);opacity:1;}}

.banner{
  position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);
  background:rgba(5,5,12,.97);border:2px solid var(--gold);border-radius:14px;
  padding:18px 36px;font-family:'Press Start 2P',monospace;font-size:15px;
  color:var(--gold);z-index:400;text-align:center;line-height:1.7;
  animation:bpop .35s ease-out;
}
@keyframes bpop{from{transform:translate(-50%,-50%) scale(.5);opacity:0;}to{transform:translate(-50%,-50%) scale(1);opacity:1;}}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   WIN SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#winscreen{
  background:radial-gradient(ellipse at 50% 30%,#1a0d33,var(--bg));
  padding:30px 20px;justify-content:center;text-align:center;gap:0;
}
.trophy{font-size:72px;animation:tspin 2s ease-in-out infinite;}
@keyframes tspin{0%,100%{transform:rotate(-5deg) scale(1);}50%{transform:rotate(5deg) scale(1.1);}}
.win-title{font-family:'Press Start 2P',monospace;font-size:clamp(13px,4vw,20px);color:var(--gold);margin:18px 0 8px;line-height:1.5;text-shadow:0 0 30px rgba(255,215,0,.5);}
.win-sub{font-size:20px;font-weight:700;color:var(--lucky);margin-bottom:18px;}
.rewards{display:flex;gap:14px;justify-content:center;margin:14px 0;}
.rwrd{background:var(--surface);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:14px 18px;text-align:center;}
.rwrd .re{font-size:28px;display:block;margin-bottom:5px;}
.rwrd .ra{font-family:'Press Start 2P',monospace;font-size:14px;color:var(--gold);}
.rwrd .rl{font-family:'Orbitron',sans-serif;font-size:8px;color:var(--muted);letter-spacing:2px;margin-top:3px;}
.lb{width:100%;max-width:340px;margin:14px 0;}
.lb-hdr{font-family:'Press Start 2P',monospace;font-size:9px;color:var(--muted);margin-bottom:10px;}
.lb-row{display:flex;align-items:center;gap:10px;background:var(--surface);border-radius:8px;padding:9px 12px;margin-bottom:5px;border:1px solid rgba(255,255,255,.06);}
.lb-row.winner{border-color:rgba(255,215,0,.4);background:rgba(255,215,0,.05);}
.lb-pos{font-family:'Press Start 2P',monospace;font-size:10px;width:20px;color:var(--muted);}
.lb-av{font-size:20px;}
.lb-name{flex:1;font-size:14px;font-weight:700;}
.lb-score{font-family:'Orbitron',sans-serif;font-size:10px;color:var(--gold);}
.shop-modal{display:none;width:100%;max-width:340px;background:var(--surface);border-radius:14px;padding:18px;border:1px solid rgba(255,255,255,.08);margin-bottom:16px;}
.shop-title{font-family:'Press Start 2P',monospace;font-size:10px;color:var(--gold);margin-bottom:14px;}
.shop-item{display:flex;align-items:center;gap:10px;padding:9px;border-bottom:1px solid rgba(255,255,255,.04);}
.shop-item:last-child{border-bottom:none;}
.si-em{font-size:26px;}.si-info{flex:1;}.si-name{font-size:13px;font-weight:700;}
.si-rarity{font-size:9px;color:var(--muted);font-family:'Orbitron',sans-serif;}
.si-btn{background:linear-gradient(135deg,#ffd700,#ff8c00);border:none;border-radius:7px;padding:5px 8px;font-family:'Press Start 2P',monospace;font-size:7px;cursor:pointer;color:#000;}

/* Confetti */
.confetti-p{position:fixed;width:8px;height:8px;border-radius:2px;animation:cfall linear forwards;z-index:500;pointer-events:none;}
@keyframes cfall{0%{transform:translateY(-10vh) rotate(0deg);opacity:1;}100%{transform:translateY(110vh) rotate(720deg);opacity:0;}}

@media(max-width:380px){
  .card{width:56px;height:80px;}.cem{font-size:19px;}.cname{font-size:6px;}
}
</style>
</head>
<body>

<div id="connDot" class="wait">â— CONNECTING</div>

<!-- â•â•â•â•â•â•â• LOBBY â•â•â•â•â•â•â• -->
<div id="lobby" class="screen active">
  <div class="logo">
    <h1>ğŸ® CONSOLE<br>CATCH</h1>
    <p>REAL-TIME MULTIPLAYER</p>
  </div>
  <div class="parade">
    <div class="parade-card card-beige">ğŸ•¹ï¸</div>
    <div class="parade-card card-green">ğŸ“€</div>
    <div class="parade-card card-blue">ğŸ’¿</div>
    <div class="parade-card card-yellow">ğŸŸ©</div>
    <div class="parade-card card-orange">ğŸ²</div>
    <div class="parade-card card-grey">âŒ¨ï¸</div>
    <div class="parade-card card-red">ğŸ¥½</div>
  </div>
  <div class="card-box">
    <div class="field">
      <label>YOUR NAME</label>
      <input id="nameIn" placeholder="Enter your nameâ€¦" maxlength="16" autocomplete="off">
    </div>
    <button class="btn btn-gold" onclick="hostGame()">ğŸ  HOST A GAME</button>
    <div class="divider">â€” OR JOIN A ROOM â€”</div>
    <div class="field">
      <label>ROOM CODE</label>
      <input id="codeIn" placeholder="e.g. SONIC42" maxlength="10"
        style="text-transform:uppercase;letter-spacing:4px;font-family:'Press Start 2P',monospace;font-size:12px;" autocomplete="off">
    </div>
    <button class="btn btn-dim" onclick="joinGame()">ğŸ® JOIN GAME</button>
  </div>
</div>

<!-- â•â•â•â•â•â•â• WAITING ROOM â•â•â•â•â•â•â• -->
<div id="waiting" class="screen">
  <button class="back-btn" onclick="leaveRoom()">â† BACK TO MENU</button>

  <div class="room-code-box">
    <span>ROOM:</span>
    <strong id="dispCode">----</strong>
    <div class="copy-icon" onclick="copyCode()" title="Copy code">ğŸ“‹</div>
  </div>

  <div class="lobby-players" id="lobbyPlayers">
    <div class="lobby-players-header">
      <span>PLAYERS IN LOBBY</span>
      <span id="lobbyCount">0 / 6</span>
    </div>
    <!-- rows injected here -->
  </div>

  <div class="bot-controls" id="botControls" style="display:none;">
    <button class="btn-sm btn-blue" onclick="addBot()" style="flex:1;">ğŸ¤– + Add Bot</button>
    <button class="btn-sm btn-red" onclick="removeBot()" style="flex:1;">ğŸ¤– âˆ’ Remove Bot</button>
  </div>

  <div class="waiting-actions">
    <button class="btn btn-gold" id="startBtn" style="display:none;" onclick="startGame()">â–¶ START GAME</button>
    <div id="waitMsg" style="text-align:center;font-family:'Orbitron',sans-serif;font-size:9px;color:var(--muted);letter-spacing:1px;padding:10px;">
      Waiting for host to startâ€¦
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â• GAME â•â•â•â•â•â•â• -->
<div id="game" class="screen">
  <div class="game-header">
    <div style="display:flex;gap:7px;">
      <div class="hchip gold">ğŸ¥‡<span id="goldCnt">0</span></div>
      <div class="hchip lucky">ğŸ€<span id="luckyCnt">0</span></div>
    </div>
    <div class="turn-badge" id="turnBadge">â€”</div>
    <div class="hchip rnd">R<span id="rndNum">1</span></div>
  </div>

  <!-- Big timer -->
  <div class="timer-wrap">
    <div class="timer-bar"><div class="timer-fill" id="timerFill"></div></div>
    <div class="timer-countdown" id="timerNum" style="color:var(--green);">30</div>
  </div>

  <div class="game-main">

    <!-- Opponents -->
    <div>
      <div style="font-family:'Orbitron',sans-serif;font-size:8px;letter-spacing:2px;color:rgba(255,255,255,.28);margin-bottom:7px;">OTHER PLAYERS</div>
      <div class="opp-row" id="oppRow"></div>
    </div>

    <!-- Table -->
    <div class="table-center">
      <div class="pile-sec">
        <div class="pile-lbl">DECK</div>
        <div class="card card-back" id="deckCard" onclick="drawDeck()">
          <div class="cem" style="position:relative;z-index:1;">ğŸ®</div>
        </div>
        <div class="deck-count" id="deckCnt">â€” cards</div>
      </div>
      <div class="table-sep">âš¡</div>
      <div class="pile-sec">
        <div class="pile-lbl">DISCARD PILE</div>
        <div class="card" id="discardTop" onclick="drawDiscard()">
          <div class="cem">â™»ï¸</div>
          <div class="cname" style="color:rgba(255,255,255,.3);">Empty</div>
        </div>
      </div>
    </div>

    <!-- Locked Sets -->
    <div class="sec">
      <div class="sec-hdr">
        <div class="sec-title">ğŸ”’ LOCKED SETS (<span id="lockedCount">0</span>/3)</div>
        <div style="font-family:'Orbitron',sans-serif;font-size:8px;color:var(--muted);">Lock 3 to WIN!</div>
      </div>
      <div class="sets-row" id="setsRow">
        <div class="set-slot" id="set0"><span class="slot-lbl">SET 1</span><div class="plus-hint">+</div></div>
        <div class="set-slot" id="set1"><span class="slot-lbl">SET 2</span><div class="plus-hint">+</div></div>
        <div class="set-slot" id="set2"><span class="slot-lbl">SET 3</span><div class="plus-hint">+</div></div>
      </div>
    </div>

    <!-- Staging area -->
    <div class="sec" id="stageSec">
      <div class="sec-hdr">
        <div class="sec-title">ğŸ¯ BUILD A SET</div>
        <div class="sec-actions">
          <button class="btn-sm btn-red" id="clearStageBtn" onclick="clearStage()" disabled>âœ• Clear</button>
          <button class="btn-sm btn-green" id="lockStageBtn" onclick="lockStage()" disabled>ğŸ”’ LOCK SET</button>
        </div>
      </div>
      <div class="stage-cards" id="stageCards">
        <div class="stage-hint" id="stageHint">Tap cards from your hand to stage them here (need 3)</div>
      </div>
      <div id="stageStatus" style="font-family:'Orbitron',sans-serif;font-size:9px;margin-top:7px;letter-spacing:1px;text-align:center;min-height:16px;"></div>
    </div>

    <!-- Hand -->
    <div class="sec">
      <div class="sec-hdr">
        <div class="sec-title">YOUR HAND (<span id="handCnt">0</span>)</div>
        <div class="sec-actions">
          <button class="btn-sm btn-blue" onclick="autoStage()">âœ¨ Auto</button>
          <button class="btn-sm btn-red" id="discardBtn" onclick="discardSelected()" disabled>ğŸ—‘ï¸ DISCARD</button>
        </div>
      </div>
      <div class="hand-cards" id="handCards"></div>
      <div class="turn-hint" id="turnHint">â€”</div>
    </div>

  </div>
</div>

<!-- â•â•â•â•â•â•â• WIN â•â•â•â•â•â•â• -->
<div id="winscreen" class="screen">
  <div class="trophy">ğŸ†</div>
  <div class="win-title" id="winTitle">WINNER!</div>
  <div class="win-sub" id="winSub">â€”</div>
  <div class="rewards">
    <div class="rwrd"><span class="re">ğŸ¥‡</span><div class="ra" id="wGold">+0</div><div class="rl">GOLD</div></div>
    <div class="rwrd"><span class="re">ğŸ€</span><div class="ra" id="wLucky">+0</div><div class="rl">LUCKY</div></div>
  </div>
  <div class="lb">
    <div class="lb-hdr">ğŸ“Š FINAL SCORES</div>
    <div id="lbRows"></div>
  </div>
  <div style="width:100%;max-width:340px;margin-top:8px;">
    <button class="btn btn-gold" onclick="toggleShop()" style="margin-bottom:8px;">ğŸ›’ VINTAGE SHOP</button>
    <button class="btn btn-dim" onclick="backToLobby()">ğŸ”„ PLAY AGAIN</button>
  </div>
  <div class="shop-modal" id="shopModal">
    <div class="shop-title">ğŸ•¹ï¸ RARE VINTAGE SHOP</div>
    <div id="shopItems"></div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SOCKET
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const socket = io();
let myId = null;
socket.on('connect', () => { myId = socket.id; dot('ok','â— LIVE'); });
socket.on('disconnect', () => dot('bad','â— OFFLINE'));
socket.on('connect_error', () => dot('bad','â— ERROR'));
function dot(cls,txt){ const d=document.getElementById('connDot'); d.className=cls; d.textContent=txt; }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CLIENT STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let roomCode = '';
let amHost = false;
let myHand = [];
let mySets = [[], [], []];
let myLockedSets = 0;
let myLockedSetCards = [[], [], []];
let hasDrawn = false;
let isMyTurn = false;
let selectedIdx = null;   // card selected for discard
let stagedCards = [];     // cards staged to form a set
let currentState = null;  // latest game_state from server
let timerInt = null;
let timerSecs = 30;
let myGold = 0;
let myLucky = 0;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LOBBY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function hostGame() {
  const name = document.getElementById('nameIn').value.trim();
  if (!name) return notif('âš ï¸ Enter your name!');
  socket.emit('host_game', { playerName: name });
}
function joinGame() {
  const name = document.getElementById('nameIn').value.trim();
  const code = document.getElementById('codeIn').value.trim().toUpperCase();
  if (!name) return notif('âš ï¸ Enter your name!');
  if (!code) return notif('âš ï¸ Enter a room code!');
  socket.emit('join_game', { playerName: name, roomCode: code });
}

socket.on('room_created', ({ roomCode: code }) => {
  roomCode = code; amHost = true;
  document.getElementById('dispCode').textContent = code;
  document.getElementById('startBtn').style.display = 'block';
  document.getElementById('waitMsg').style.display = 'none';
  document.getElementById('botControls').style.display = 'flex';
  showScreen('waiting');
});
socket.on('room_joined', ({ roomCode: code }) => {
  roomCode = code; amHost = false;
  document.getElementById('dispCode').textContent = code;
  document.getElementById('startBtn').style.display = 'none';
  document.getElementById('waitMsg').style.display = 'block';
  document.getElementById('botControls').style.display = 'none';
  showScreen('waiting');
});
socket.on('you_are_host', () => {
  amHost = true;
  document.getElementById('startBtn').style.display = 'block';
  document.getElementById('waitMsg').style.display = 'none';
  document.getElementById('botControls').style.display = 'flex';
  notif('ğŸ‘‘ You are now the host!');
});
socket.on('left_room', () => { resetClientState(); showScreen('lobby'); });
socket.on('player_joined', ({ name, avatar, isBot }) => {
  notif(`${avatar} ${name}${isBot ? ' ğŸ¤–' : ''} joined!`);
});
socket.on('player_left', ({ name, avatar }) => notif(`${avatar} ${name} left`));
socket.on('error', ({ message }) => notif(`âŒ ${message}`));

function leaveRoom() {
  socket.emit('leave_room');
}
function addBot() { socket.emit('add_bot'); }
function removeBot() { socket.emit('remove_bot'); }
function startGame() { socket.emit('start_game'); }
function copyCode() {
  navigator.clipboard?.writeText(roomCode).catch(()=>{});
  notif(`ğŸ“‹ Copied: ${roomCode}`);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GAME STATE SYNC
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
socket.on('game_state', (state) => {
  currentState = state;

  // Render lobby player list if in waiting room
  if (state.phase === 'waiting') {
    renderLobbyPlayers(state);
    return;
  }

  // Switch to game screen if needed
  if (!document.getElementById('game').classList.contains('active') &&
      state.phase === 'playing') {
    showScreen('game');
  }

  renderGameState(state);
});

socket.on('game_started', () => {
  showScreen('game');
  banner('ğŸ® GAME START!');
});

socket.on('your_hand', ({ hand, sets, lockedSets, lockedSetCards, hasDrawn: hd }) => {
  myHand = hand;
  mySets = sets;
  myLockedSets = lockedSets;
  myLockedSetCards = lockedSetCards;
  hasDrawn = hd;
  // Clear staged cards that are no longer in hand
  stagedCards = stagedCards.filter(sc =>
    myHand.some(c => c.id === sc.id && c.color === sc.color)
  );
  renderHand();
  renderSets();
  renderStage();
  updateButtons();
});

socket.on('set_locked', ({ slotIndex, lockedSets }) => {
  myLockedSets = lockedSets;
  stagedCards = [];
  document.getElementById('lockedCount').textContent = lockedSets;
  notif(`ğŸ”’ Set ${slotIndex + 1} locked! (${lockedSets}/3)`);
  renderStage();
  updateButtons();
});

socket.on('timer_start', ({ seconds, playerId }) => {
  timerSecs = seconds;
  isMyTurn = (playerId === myId);
  startTimerUI(seconds);
  updateTurnHint();
  updateButtons();
  updateTableInteractive();
});

socket.on('card_drawn', ({ card, source }) => {
  notif(`${card.emoji} ${card.name} drawn from ${source}!`, 1600);
});
socket.on('force_move', () => notif('â° Time expired! Auto-move.'));
socket.on('deck_reshuffled', () => notif('ğŸ”„ Deck reshuffled!'));

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderLobbyPlayers(state) {
  const container = document.getElementById('lobbyPlayers');
  const realCount = state.players.filter(p => !p.isBot).length;
  document.getElementById('lobbyCount').textContent = `${state.players.length} / 6`;

  let html = `<div class="lobby-players-header">
    <span>PLAYERS IN LOBBY</span>
    <span>${state.players.length} / 6</span>
  </div>`;

  state.players.forEach(p => {
    const isYou = p.id === myId;
    const isHost = p.id === state.hostId;
    let tag = '';
    if (isHost && !p.isBot) tag = '<span class="ptag ptag-host">HOST</span>';
    else if (p.isBot) tag = '<span class="ptag ptag-bot">ğŸ¤– BOT</span>';
    else tag = '<span class="ptag ptag-ready">READY</span>';
    html += `<div class="player-row${isYou ? ' you' : ''}">
      <div class="pav">${p.avatar}</div>
      <div class="pname">${p.name}${isYou ? ' (You)' : ''}</div>
      ${tag}
    </div>`;
  });

  // Empty slots
  for (let i = state.players.length; i < 6; i++) {
    html += `<div class="empty-row">â€” waiting for player ${i+1} â€”</div>`;
  }

  container.innerHTML = html;
}

function renderGameState(state) {
  if (!state) return;
  document.getElementById('rndNum').textContent = state.round || 1;
  document.getElementById('deckCnt').textContent = `${state.deckCount} cards`;

  // Top discard
  const dEl = document.getElementById('discardTop');
  if (state.topDiscard) {
    const d = state.topDiscard;
    dEl.className = `card card-${d.color}`;
    dEl.innerHTML = `<div class="cem">${d.emoji}</div><div class="cname">${d.name}</div>`;
  } else {
    dEl.className = 'card';
    dEl.innerHTML = '<div class="cem">â™»ï¸</div><div class="cname" style="color:rgba(255,255,255,.3);">Empty</div>';
  }

  // Turn badge
  const cur = state.players[state.currentTurn];
  const myTurn = cur && cur.id === myId;
  const tb = document.getElementById('turnBadge');
  if (myTurn) { tb.textContent = 'âš¡ YOUR TURN'; tb.style.color = 'var(--green)'; }
  else if (cur) { tb.textContent = `${cur.avatar} ${cur.name}`; tb.style.color = 'rgba(255,255,255,.45)'; }

  // Opponents
  renderOpponents(state);

  // My stats
  const me = state.players.find(p => p.id === myId);
  if (me) {
    document.getElementById('goldCnt').textContent = me.gold;
    document.getElementById('luckyCnt').textContent = me.lucky;
    document.getElementById('lockedCount').textContent = me.lockedSets;
  }
}

function renderOpponents(state) {
  const row = document.getElementById('oppRow');
  row.innerHTML = '';
  state.players.forEach((p, i) => {
    if (p.id === myId) return;
    const active = state.currentTurn === i;
    const div = document.createElement('div');
    div.className = `opp-card${active ? ' myturn' : ''}`;
    const peekCards = p.discardPile && p.discardPile.length > 0
      ? p.discardPile.slice(-6).map(c => `<div class="mpcard card-${c.color}" title="${c.name}">${c.emoji}</div>`).join('')
      : '<div style="font-size:10px;color:rgba(255,255,255,.25);">Empty</div>';
    div.innerHTML = `
      <div class="opp-av">${p.avatar}${p.isBot ? '<sup style="font-size:8px">ğŸ¤–</sup>' : ''}</div>
      <div class="opp-name">${p.name}</div>
      <div class="opp-info">ğŸƒ ${p.cardCount} cards</div>
      ${p.lockedSets > 0 ? `<div class="opp-sets-done">ğŸ”’ ${p.lockedSets}/3</div>` : ''}
      <div class="peek-popup">
        <div class="peek-title">${p.name}'s DISCARD</div>
        <div class="peek-cards">${peekCards}</div>
      </div>`;
    row.appendChild(div);
  });
}

function renderHand() {
  const container = document.getElementById('handCards');
  container.innerHTML = '';
  document.getElementById('handCnt').textContent = myHand.length;
  const canInteract = isMyTurn;

  myHand.forEach((card, i) => {
    const isSelected = selectedIdx === i;
    const isStaged = stagedCards.some(s => s._handIdx === i);
    const el = document.createElement('div');
    el.className = `card card-${card.color}${canInteract ? ' hoverable' : ''}${isSelected ? ' selected' : ''}${isStaged ? ' staged' : ''}`;
    el.innerHTML = `<div class="cem">${card.emoji}</div><div class="cname">${card.name}</div>`;
    el.onclick = () => handleCardClick(i);
    container.appendChild(el);
  });
}

function renderSets() {
  for (let i = 0; i < 3; i++) {
    const slot = document.getElementById(`set${i}`);
    const locked = myLockedSetCards[i] && myLockedSetCards[i].length === 3;

    if (locked) {
      slot.className = 'set-slot locked';
      const cards = myLockedSetCards[i].map(c =>
        `<div class="card card-${c.color} locked-card" style="width:44px;height:62px;">
          <div class="cem" style="font-size:16px;">${c.emoji}</div>
          <div class="cname" style="font-size:6px;">${c.name}</div>
        </div>`).join('');
      slot.innerHTML = `<span class="slot-lbl">ğŸ”’ SET ${i+1}</span>${cards}`;
    } else {
      slot.className = 'set-slot';
      slot.innerHTML = `<span class="slot-lbl">SET ${i+1}</span><div class="plus-hint">+</div>`;
    }
  }
  document.getElementById('lockedCount').textContent = myLockedSets;
}

function renderStage() {
  const container = document.getElementById('stageCards');
  const hint = document.getElementById('stageHint');
  const status = document.getElementById('stageStatus');

  if (stagedCards.length === 0) {
    container.innerHTML = '';
    hint.style.display = 'block';
    hint.textContent = 'Tap cards from your hand to stage them here (need 3)';
    status.textContent = '';
    status.style.color = 'var(--muted)';
    return;
  }

  hint.style.display = 'none';
  container.innerHTML = stagedCards.map((c, i) =>
    `<div class="card card-${c.color} staged" style="width:58px;height:82px;" onclick="unstageCard(${i})">
      <div class="cem" style="font-size:20px;">${c.emoji}</div>
      <div class="cname" style="font-size:6px;">${c.name}</div>
    </div>`
  ).join('');

  if (stagedCards.length < 3) {
    status.textContent = `${stagedCards.length}/3 cards â€” need ${3 - stagedCards.length} more`;
    status.style.color = 'var(--muted)';
  } else {
    const valid = isValidSet(stagedCards);
    if (valid) {
      status.textContent = 'âœ… Valid set! Ready to lock in.';
      status.style.color = 'var(--green)';
    } else {
      status.textContent = 'âŒ Not a valid set â€” need 3 identical or 3 same color';
      status.style.color = 'var(--red)';
    }
  }

  updateButtons();
}

function updateButtons() {
  const discBtn = document.getElementById('discardBtn');
  const lockBtn = document.getElementById('lockStageBtn');
  const clearBtn = document.getElementById('clearStageBtn');
  const canDiscard = isMyTurn && hasDrawn && selectedIdx !== null;
  const canLock = stagedCards.length === 3 && isValidSet(stagedCards) && myLockedSets < 3;
  discBtn.disabled = !canDiscard;
  lockBtn.disabled = !canLock;
  clearBtn.disabled = stagedCards.length === 0;
  if (canDiscard) { discBtn.style.borderColor = 'rgba(255,50,50,.5)'; discBtn.style.color = '#ff7070'; }
  else { discBtn.style.borderColor = ''; discBtn.style.color = ''; }
}

function updateTurnHint() {
  const h = document.getElementById('turnHint');
  if (isMyTurn) {
    if (!hasDrawn) h.textContent = 'ğŸ‘† Tap DECK or DISCARD PILE to draw a card first';
    else h.textContent = 'ğŸ‘† Stage 3 cards â†’ Lock Set, OR select a card â†’ Discard';
  } else {
    const cur = currentState?.players[currentState?.currentTurn];
    h.textContent = cur ? `â³ ${cur.avatar} ${cur.name}'s turnâ€¦` : 'â³ Waitingâ€¦';
  }
}

function updateTableInteractive() {
  const canDraw = isMyTurn && !hasDrawn;
  const dc = document.getElementById('deckCard');
  const dd = document.getElementById('discardTop');
  if (canDraw) { dc.classList.add('pulse'); dc.classList.remove('disabled'); dd.classList.remove('disabled'); }
  else { dc.classList.remove('pulse'); dc.classList.add('disabled'); dd.classList.add('disabled'); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CARD INTERACTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function handleCardClick(idx) {
  if (!isMyTurn) return;

  // If we already have 3 staged, use click to select for discard instead
  if (stagedCards.length === 3 && isValidSet(stagedCards)) {
    // Toggle discard selection
    selectedIdx = selectedIdx === idx ? null : idx;
    renderHand();
    updateButtons();
    return;
  }

  const card = myHand[idx];
  const alreadyStaged = stagedCards.findIndex(s => s._handIdx === idx);

  if (alreadyStaged !== -1) {
    // Un-stage
    stagedCards.splice(alreadyStaged, 1);
  } else if (stagedCards.length < 3) {
    // Stage this card
    selectedIdx = null;
    stagedCards.push({ ...card, _handIdx: idx });
  } else {
    // Stage full â€” toggle discard selection
    selectedIdx = selectedIdx === idx ? null : idx;
  }

  renderHand();
  renderStage();
  updateButtons();
}

function unstageCard(stageIdx) {
  stagedCards.splice(stageIdx, 1);
  renderHand();
  renderStage();
  updateButtons();
}

function clearStage() {
  stagedCards = [];
  renderHand();
  renderStage();
  updateButtons();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTO STAGE â€” find best set in hand and stage it
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function autoStage() {
  if (myLockedSets >= 3) return;
  const cards = [...myHand];
  const byId = {}, byColor = {};
  cards.forEach((c, i) => {
    const key_id = c.id, key_col = c.color;
    if (!byId[key_id]) byId[key_id] = [];
    byId[key_id].push({ ...c, _handIdx: i });
    if (!byColor[key_col]) byColor[key_col] = [];
    byColor[key_col].push({ ...c, _handIdx: i });
  });

  // Try identical first, then color
  for (const group of [...Object.values(byId), ...Object.values(byColor)]) {
    if (group.length >= 3) {
      const triple = group.slice(0, 3);
      if (isValidSet(triple)) {
        stagedCards = triple;
        renderHand();
        renderStage();
        updateButtons();
        notif('âœ¨ Best set staged! Lock it in.');
        return;
      }
    }
  }
  notif('No complete set in hand yet â€” keep drawing!', 2000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ACTIONS â†’ SERVER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function drawDeck() {
  if (!isMyTurn || hasDrawn) return;
  socket.emit('draw_deck');
}

function drawDiscard() {
  if (!isMyTurn || hasDrawn) return;
  socket.emit('draw_discard');
}

function discardSelected() {
  if (!isMyTurn || !hasDrawn || selectedIdx === null) return;
  socket.emit('discard_card', { handIndex: selectedIdx });
  selectedIdx = null;
  stagedCards = stagedCards.filter(s => s._handIdx !== selectedIdx);
}

function lockStage() {
  if (stagedCards.length !== 3 || !isValidSet(stagedCards) || myLockedSets >= 3) return;
  // Find the first empty locked slot
  let slotIndex = -1;
  for (let i = 0; i < 3; i++) {
    if (!myLockedSetCards[i] || myLockedSetCards[i].length === 0) { slotIndex = i; break; }
  }
  if (slotIndex === -1) return notif('All slots full!');
  // Strip the _handIdx helper before sending
  const cards = stagedCards.map(({ _handIdx, ...c }) => c);
  socket.emit('lock_set', { slotIndex, cards });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TIMER UI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startTimerUI(secs) {
  stopTimerUI();
  timerSecs = secs;
  setTimer(secs);
  timerInt = setInterval(() => {
    timerSecs--;
    setTimer(timerSecs);
    if (timerSecs <= 0) stopTimerUI();
  }, 1000);
}
function stopTimerUI() {
  if (timerInt) { clearInterval(timerInt); timerInt = null; }
}
function setTimer(s) {
  const fill = document.getElementById('timerFill');
  const num = document.getElementById('timerNum');
  const pct = Math.max(0, (s / 30) * 100);
  fill.style.width = pct + '%';
  const col = s > 20 ? 'var(--green)' : s > 10 ? 'var(--yellow)' : 'var(--red)';
  fill.style.background = col;
  num.textContent = Math.max(0, s);
  num.style.color = col;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WIN SCREEN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
socket.on('game_over', ({ winner, goldEarned, luckyEarned, finalScores }) => {
  stopTimerUI();
  const isWinner = winner.id === myId;
  if (isWinner) { myGold += goldEarned; myLucky += luckyEarned; }
  setTimeout(() => {
    showScreen('winscreen');
    document.getElementById('winTitle').textContent = isWinner ? 'ğŸ† YOU WIN!' : `${winner.avatar} ${winner.name} WINS!`;
    document.getElementById('winSub').textContent = isWinner ? 'ğŸ‰ Congratulations!' : 'Better luck next time!';
    document.getElementById('wGold').textContent = `+${isWinner ? goldEarned : 0}`;
    document.getElementById('wLucky').textContent = `+${isWinner ? luckyEarned : 0}`;
    const medals = ['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰','4','5','6'];
    document.getElementById('lbRows').innerHTML = finalScores.map((p, i) => `
      <div class="lb-row${p.id === winner.id ? ' winner' : ''}">
        <div class="lb-pos">${medals[i] || i+1}</div>
        <div class="lb-av">${p.avatar}</div>
        <div class="lb-name">${p.name}${p.id === myId ? ' (You)' : ''}${p.isBot ? ' ğŸ¤–' : ''}</div>
        <div class="lb-score">ğŸ”’${p.lockedSets} sets</div>
      </div>`).join('');
    if (isWinner) spawnConfetti();
    renderShop();
  }, 600);
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function isValidSet(cards) {
  if (!cards || cards.length !== 3) return false;
  if (cards.every(c => c.id === cards[0].id)) return true;
  if (cards.every(c => c.color === cards[0].color)) return true;
  return false;
}

function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

let notifT;
function notif(msg, dur = 2400) {
  document.querySelector('.notif')?.remove();
  const el = document.createElement('div');
  el.className = 'notif'; el.textContent = msg;
  document.body.appendChild(el);
  clearTimeout(notifT);
  notifT = setTimeout(() => el.remove(), dur);
}

let bannerT;
function banner(msg) {
  document.querySelector('.banner')?.remove();
  const el = document.createElement('div');
  el.className = 'banner'; el.textContent = msg;
  document.body.appendChild(el);
  clearTimeout(bannerT);
  bannerT = setTimeout(() => el.remove(), 2200);
}

function spawnConfetti() {
  const cols = ['#ffd700','#ff1744','#00e676','#448aff','#ff6d00','#e040fb','#00ffff','#fff'];
  for (let i = 0; i < 70; i++) {
    setTimeout(() => {
      const el = document.createElement('div');
      el.className = 'confetti-p';
      el.style.left = Math.random()*100+'vw';
      el.style.background = cols[Math.floor(Math.random()*cols.length)];
      el.style.animationDuration = (1.5+Math.random()*2.5)+'s';
      document.body.appendChild(el);
      setTimeout(()=>el.remove(), 5000);
    }, Math.random()*1200);
  }
}

function resetClientState() {
  myHand=[]; mySets=[[],[],[]]; myLockedSets=0; myLockedSetCards=[[],[],[]];
  hasDrawn=false; isMyTurn=false; selectedIdx=null; stagedCards=[]; currentState=null;
  stopTimerUI();
}

function backToLobby() {
  document.getElementById('shopModal').style.display='none';
  resetClientState();
  showScreen('lobby');
}

function toggleShop() {
  const m = document.getElementById('shopModal');
  m.style.display = m.style.display==='none' ? 'block' : 'none';
}

// Shop
const SHOP = [
  {emoji:'ğŸ•¹ï¸',name:'Atari 2600',price:50,rarity:'ğŸŒŸ Rare'},
  {emoji:'ğŸ“º',name:'Vectrex',price:80,rarity:'ğŸ’ Epic'},
  {emoji:'ğŸ®',name:'Virtual Boy',price:65,rarity:'ğŸŒŸ Rare'},
  {emoji:'ğŸ‘¾',name:'ColecoVision',price:45,rarity:'âœ¨ Uncommon'},
  {emoji:'ğŸ’¾',name:'3DO Interactive',price:90,rarity:'ğŸ’ Epic'},
  {emoji:'ğŸŒ€',name:'Jaguar CD',price:120,rarity:'ğŸ”¥ Legendary'},
  {emoji:'ğŸ†',name:'Neo Geo Gold',price:150,rarity:'ğŸ”¥ Legendary'},
];
function renderShop() {
  document.getElementById('shopItems').innerHTML = SHOP.map(it=>`
    <div class="shop-item">
      <div class="si-em">${it.emoji}</div>
      <div class="si-info"><div class="si-name">${it.name}</div><div class="si-rarity">${it.rarity}</div></div>
      <button class="si-btn" onclick="buyItem('${it.name}',${it.price})">ğŸ€${it.price}</button>
    </div>`).join('');
}
function buyItem(name, price) {
  if (myLucky < price) return notif(`âŒ Need ${price} Lucky Coins!`);
  myLucky -= price; notif(`ğŸ‰ Purchased ${name}!`);
}

// Keyboard shortcuts
document.addEventListener('keydown', e => {
  if (e.key==='Enter') {
    if (document.getElementById('lobby').classList.contains('active')) {
      document.getElementById('codeIn').value.trim() ? joinGame() : hostGame();
    }
  }
  if ((e.key==='q'||e.key==='Q') && document.getElementById('game').classList.contains('active')) {
    notif('ğŸ‘ï¸ Hover/tap an opponent to peek their discard pile!');
  }
});

renderShop();
</script>
</body>
</html>
